# .github/workflows/deploy-infra.yml
# μΈν”„λΌ λ°°ν¬ μ›ν¬ν”λ΅μ° (Terraform λ³€κ²½μ‹λ§ μ‹¤ν–‰)

name: Deploy Infrastructure

on:
  push:
    branches: [ main ]
    paths:
      - 'WALB/infrastructure/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'WALB/infrastructure/**'

env:
  PROJECT_NAME: "WALB-app"
  TF_VERSION: "1.5.0"

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    # μ›ν‚Ή λ””λ ‰ν† λ¦¬λ¥Ό WALBλ΅ μ„¤μ •
    defaults:
      run:
        working-directory: ./WALB/infrastructure/terraform
    
    permissions:
      id-token: write
      contents: read

    steps:
    # ===============================================
    # μ†μ¤μ½”λ“ μ²΄ν¬μ•„μ›ƒ
    # ===============================================
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================================
    # Terraform μ„¤μ •
    # ===============================================
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # ===============================================
    # AWS μΈμ¦ (OIDC λ°©μ‹)
    # ===============================================
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_INFRA }}
        aws-region: ${{ secrets.AWS_REGION }}
        role-session-name: GitHubActions-Infrastructure-${{ github.run_id }}

    # ===============================================
    # Terraform μ΄κΈ°ν™”
    # ===============================================
    - name: Terraform Init
      run: |
        echo "π”§ Terraform μ΄κΈ°ν™” μ¤‘..."
        terraform init
        echo "β… Terraform μ΄κΈ°ν™” μ™„λ£"

    # ===============================================
    # Terraform ν•μ‹ κ²€μ¦
    # ===============================================
    - name: Terraform Format Check
      run: |
        echo "π“ Terraform ν•μ‹ κ²€μ¦ μ¤‘..."
        terraform fmt -check -recursive
        echo "β… ν•μ‹ κ²€μ¦ μ™„λ£"

    # ===============================================
    # Terraform μ ν¨μ„± κ²€μ¦
    # ===============================================
    - name: Terraform Validate
      run: |
        echo "π” Terraform κµ¬μ„± κ²€μ¦ μ¤‘..."
        terraform validate
        echo "β… κµ¬μ„± κ²€μ¦ μ™„λ£"

    # ===============================================
    # Terraform Plan (PRμΌ λ•)
    # ===============================================
    - name: Terraform Plan
      if: github.event_name == 'pull_request'
      run: |
        echo "π“‹ Terraform Plan μ‹¤ν–‰ μ¤‘..."
        terraform plan -no-color -out=tfplan
        echo "β… Plan μ‹¤ν–‰ μ™„λ£"

    # ===============================================
    # PR μ½”λ©νΈμ— Plan κ²°κ³Ό μ¶”κ°€
    # ===============================================
    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          try {
            const planOutput = execSync('cd infrastructure/terraform && terraform show -no-color tfplan', { encoding: 'utf8' });
            
            const comment = `## π—οΈ Terraform Plan κ²°κ³Ό
            
            ### π“‹ λ³€κ²½ μ‚¬ν•­ μ”μ•½
            \`\`\`
            ${planOutput.substring(0, 4000)}
            \`\`\`
            
            ### β„ΉοΈ μ¶”κ°€ μ •λ³΄
            - **μ›ν¬ν”λ΅μ°**: Infrastructure Deploy
            - **ν™κ²½**: ${process.env.PROJECT_NAME}
            - **μ»¤λ°‹**: ${context.sha.substring(0, 8)}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Plan κ²°κ³Όλ¥Ό κ°€μ Έμ¬ μ μ—†μµλ‹λ‹¤:', error);
          }

    # ===============================================
    # Terraform Apply (main λΈλμΉμΌ λ•λ§)
    # ===============================================
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "π€ μΈν”„λΌ λ°°ν¬ μ¤‘..."
        terraform apply -auto-approve
        echo "β… μΈν”„λΌ λ°°ν¬ μ™„λ£"

    # ===============================================
    # λ°°ν¬ κ²°κ³Ό ν™•μΈ
    # ===============================================
    - name: Verify Infrastructure
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "π” λ°°ν¬λ λ¦¬μ†μ¤ ν™•μΈ μ¤‘..."
        
        # VPC ν™•μΈ
        VPC_ID=$(terraform output -raw vpc_id 2>/dev/null || echo "")
        if [ -n "$VPC_ID" ]; then
          echo "β… VPC: $VPC_ID"
        fi
        
        # EKS ν΄λ¬μ¤ν„° ν™•μΈ
        EKS_CLUSTER=$(terraform output -raw eks_cluster_name 2>/dev/null || echo "")
        if [ -n "$EKS_CLUSTER" ]; then
          echo "β… EKS Cluster: $EKS_CLUSTER"
          aws eks describe-cluster --name $EKS_CLUSTER --query 'cluster.status' --output text
        fi
        
        # RDS ν™•μΈ
        RDS_ENDPOINT=$(terraform output -raw rds_endpoint 2>/dev/null || echo "")
        if [ -n "$RDS_ENDPOINT" ]; then
          echo "β… RDS Endpoint: $RDS_ENDPOINT"
        fi
        
        # S3 λ²„ν‚· ν™•μΈ
        S3_LOGS_BUCKET=$(terraform output -raw s3_logs_bucket_name 2>/dev/null || echo "")
        if [ -n "$S3_LOGS_BUCKET" ]; then
          echo "β… S3 Logs Bucket: $S3_LOGS_BUCKET"
        fi

    # ===============================================
    # μΈν”„λΌ λ°°ν¬ μ™„λ£ μ•λ¦Ό
    # ===============================================
    - name: Infrastructure Deployment Notification
      if: success() && github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "π‰ μΈν”„λΌ λ°°ν¬ μ™„λ£!"
        echo "ν”„λ΅μ νΈ: ${{ env.PROJECT_NAME }}"
        echo "λ¦¬μ „: ${{ secrets.AWS_REGION }}"
        echo "μ»¤λ°‹: ${{ github.sha }}"
        echo "λ°°ν¬ μ‹κ°„: $(date)"

    # ===============================================
    # λ°°ν¬ μ‹¤ν¨ μ‹ λ΅¤λ°± μ •λ³΄ μ κ³µ
    # ===============================================
    - name: Rollback Information
      if: failure() && github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "β μΈν”„λΌ λ°°ν¬ μ‹¤ν¨"
        echo "λ΅¤λ°±μ΄ ν•„μ”ν• κ²½μ° λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‹¤ν–‰ν•μ„Έμ”:"
        echo "terraform plan -destroy"
        echo "terraform destroy"
        echo "λλ” μ΄μ „ μ»¤λ°‹μΌλ΅ λλλ¦° ν›„ λ‹¤μ‹ λ°°ν¬ν•μ„Έμ”."