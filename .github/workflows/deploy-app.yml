# .github/workflows/deploy-app.yml
# ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì›Œí¬í”Œë¡œìš° (server í´ë” ë³€ê²½ì‹œë§Œ ì‹¤í–‰)

name: Deploy Application

on:
  push:
    branches: [ main ]
    paths:
      - 'WALB/server/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'WALB/server/**'

env:
  PROJECT_NAME: "WALB-app"
  JAVA_VERSION: "17"
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    # ì›Œí‚¹ ë””ë ‰í† ë¦¬ë¥¼ WALBë¡œ ì„¤ì •
    defaults:
      run:
        working-directory: ./WALB
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    # ===============================================
    # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
    # ===============================================
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ===============================================
    # Java í™˜ê²½ ì„¤ì •
    # ===============================================
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
    
    # ===============================================
    # Maven ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
    # ===============================================
    - name: Run tests
      run: |
        echo "ğŸ§ª ì• í”Œë¦¬ì¼€ì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        if [ -f "mvnw" ]; then
          ./mvnw test
        elif [ -f "pom.xml" ]; then
          mvn test
        else
          echo "âš ï¸ Maven í”„ë¡œì íŠ¸ê°€ ì•„ë‹™ë‹ˆë‹¤. í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
        fi
        echo "âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
    
    - name: Build with Maven
      run: |
        echo "ğŸ”¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ì¤‘..."
        if [ -f "mvnw" ]; then
          ./mvnw clean package -DskipTests
        elif [ -f "pom.xml" ]; then
          mvn clean package -DskipTests
        else
          echo "â„¹ï¸ Maven ë¹Œë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. Docker ë¹Œë“œë§Œ ì‹¤í–‰í•©ë‹ˆë‹¤."
        fi
        echo "âœ… ë¹Œë“œ ì™„ë£Œ"
    
    # ===============================================
    # AWS ì¸ì¦ (OIDC ë°©ì‹)
    # ===============================================
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ secrets.AWS_REGION }}
        role-session-name: GitHubActions-Application-${{ github.run_id }}
    
    # ===============================================
    # ê¸°ì¡´ ì¸í”„ë¼ ì •ë³´ ì¡°íšŒ
    # ===============================================
    - name: Get Infrastructure Resources
      run: |
        echo "ğŸ” ê¸°ì¡´ ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ ì •ë³´ ì¡°íšŒ ì¤‘..."
        
        # ECR ë¦¬í¬ì§€í† ë¦¬ URI ì¡°íšŒ
        ECR_REPO=$(aws ecr describe-repositories --repository-names ${PROJECT_NAME}-app --query 'repositories[0].repositoryUri' --output text 2>/dev/null || echo "")
        if [ -z "$ECR_REPO" ]; then
          echo "âŒ ECR ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${PROJECT_NAME}-app"
          echo "ë¨¼ì € ì¸í”„ë¼ ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          exit 1
        fi
        echo "ECR_REPOSITORY=$ECR_REPO" >> $GITHUB_ENV
        echo "âœ… ECR Repository: $ECR_REPO"
        
        # EKS í´ëŸ¬ìŠ¤í„° ì´ë¦„ ì¡°íšŒ
        EKS_CLUSTER=$(aws eks describe-cluster --name ${PROJECT_NAME}-eks --query 'cluster.name' --output text 2>/dev/null || echo "")
        if [ -z "$EKS_CLUSTER" ] || [ "$EKS_CLUSTER" == "None" ]; then
          echo "âŒ EKS í´ëŸ¬ìŠ¤í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${PROJECT_NAME}-eks"
          echo "ë¨¼ì € ì¸í”„ë¼ ë°°í¬ê°€ í•„ìš”í•©ë‹ˆë‹¤."
          exit 1
        fi
        echo "EKS_CLUSTER_NAME=$EKS_CLUSTER" >> $GITHUB_ENV
        echo "âœ… EKS Cluster: $EKS_CLUSTER"
        
        # EKS í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
        EKS_STATUS=$(aws eks describe-cluster --name $EKS_CLUSTER --query 'cluster.status' --output text)
        if [ "$EKS_STATUS" != "ACTIVE" ]; then
          echo "âŒ EKS í´ëŸ¬ìŠ¤í„°ê°€ í™œì„± ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤: $EKS_STATUS"
          exit 1
        fi
        echo "âœ… EKS Cluster Status: $EKS_STATUS"
    
    # ===============================================
    # ECR ë¡œê·¸ì¸
    # ===============================================
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    # ===============================================
    # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    # ===============================================
    - name: Build and push Docker image
      id: build-image
      run: |
        echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        
        # Git ì»¤ë°‹ í•´ì‹œë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
        IMAGE_TAG=${{ github.sha }}
        IMAGE_URI=${{ env.ECR_REPOSITORY }}:$IMAGE_TAG
        
        # Docker ì´ë¯¸ì§€ ë¹Œë“œ
        docker build -t $IMAGE_URI .
        docker tag $IMAGE_URI ${{ env.ECR_REPOSITORY }}:latest
        
        echo "ğŸ“¤ ECRì— ì´ë¯¸ì§€ í‘¸ì‹œ ì¤‘..."
        docker push $IMAGE_URI
        docker push ${{ env.ECR_REPOSITORY }}:latest
        
        echo "âœ… ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ: $IMAGE_URI"
        echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT
    
    # ===============================================
    # kubectl ì„¤ì¹˜ ë° EKS ì—°ê²°
    # ===============================================
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'
    
    - name: Update kubeconfig for EKS
      run: |
        echo "ğŸ”§ EKS í´ëŸ¬ìŠ¤í„° kubeconfig ì—…ë°ì´íŠ¸ ì¤‘..."
        aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}
        
        # í´ëŸ¬ìŠ¤í„° ì—°ê²° í…ŒìŠ¤íŠ¸
        echo "ğŸ” í´ëŸ¬ìŠ¤í„° ì—°ê²° í…ŒìŠ¤íŠ¸..."
        kubectl cluster-info
        kubectl get nodes
    
    # ===============================================
    # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
    # ===============================================
    - name: Generate Kubernetes manifests
      run: |
        echo "ğŸ“ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì¤‘..."
        
        # Namespace ìƒì„±
        cat <<EOF > namespace.yaml
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${{ env.PROJECT_NAME }}
          labels:
            name: ${{ env.PROJECT_NAME }}
        EOF
        
        # ConfigMap ìƒì„± (í™˜ê²½ë³€ìˆ˜)
        cat <<EOF > configmap.yaml
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${{ env.PROJECT_NAME }}-config
          namespace: ${{ env.PROJECT_NAME }}
        data:
          SPRING_PROFILES_ACTIVE: "production"
          AWS_REGION: "${{ secrets.AWS_REGION }}"
          DB_HOST: "$(terraform output -raw rds_endpoint 2>/dev/null | cut -d':' -f1)"
          DB_PORT: "5432"
          DB_NAME: "mydb"
          DB_USER: "dbadmin"
        EOF
        
        # Secret ìƒì„± (DB íŒ¨ìŠ¤ì›Œë“œ)
        cat <<EOF > secret.yaml
        apiVersion: v1
        kind: Secret
        metadata:
          name: ${{ env.PROJECT_NAME }}-secret
          namespace: ${{ env.PROJECT_NAME }}
        type: Opaque
        data:
          DB_PASSWORD: $(echo -n "MySecurePassword123!" | base64)
        EOF
        
        # Deployment ìƒì„±
        cat <<EOF > deployment.yaml
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${{ env.PROJECT_NAME }}-app
          namespace: ${{ env.PROJECT_NAME }}
          labels:
            app: ${{ env.PROJECT_NAME }}-app
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: ${{ env.PROJECT_NAME }}-app
          template:
            metadata:
              labels:
                app: ${{ env.PROJECT_NAME }}-app
            spec:
              serviceAccountName: ${{ env.PROJECT_NAME }}-service-account
              containers:
              - name: app
                image: ${{ steps.build-image.outputs.image }}
                ports:
                - containerPort: 80
                  name: http
                envFrom:
                - configMapRef:
                    name: ${{ env.PROJECT_NAME }}-config
                - secretRef:
                    name: ${{ env.PROJECT_NAME }}-secret
                livenessProbe:
                  httpGet:
                    path: /healthcheck.php
                    port: 80
                  initialDelaySeconds: 60
                  periodSeconds: 30
                  timeoutSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /healthcheck.php
                    port: 80
                  initialDelaySeconds: 30
                  periodSeconds: 10
                  timeoutSeconds: 5
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                securityContext:
                  runAsNonRoot: true
                  runAsUser: 1001
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: false
        EOF
        
        # Service ìƒì„±
        cat <<EOF > service.yaml
        apiVersion: v1
        kind: Service
        metadata:
          name: ${{ env.PROJECT_NAME }}-service
          namespace: ${{ env.PROJECT_NAME }}
          labels:
            app: ${{ env.PROJECT_NAME }}-app
        spec:
          type: ClusterIP
          ports:
          - port: 80
            targetPort: 80
            protocol: TCP
            name: http
          selector:
            app: ${{ env.PROJECT_NAME }}-app
        EOF
        
        # ServiceAccount ìƒì„± (IRSAìš©)
        cat <<EOF > serviceaccount.yaml
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: ${{ env.PROJECT_NAME }}-service-account
          namespace: ${{ env.PROJECT_NAME }}
          annotations:
            eks.amazonaws.com/role-arn: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.PROJECT_NAME }}-eks-app-role
        EOF
        
        echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ì™„ë£Œ"
    
    # ===============================================
    # EKSì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ (main ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
    # ===============================================
    - name: Deploy to EKS
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸš€ EKSì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì¤‘..."
        
        # Namespace ë¨¼ì € ìƒì„±
        kubectl apply -f namespace.yaml
        
        # ë‚˜ë¨¸ì§€ ë¦¬ì†ŒìŠ¤ ë°°í¬
        kubectl apply -f serviceaccount.yaml
        kubectl apply -f configmap.yaml
        kubectl apply -f secret.yaml
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml
        
        echo "â³ ë°°í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
        kubectl rollout status deployment/${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }} --timeout=300s
    
    # ===============================================
    # ë°°í¬ ê²°ê³¼ í™•ì¸
    # ===============================================
    - name: Verify deployment
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
        
        # Pod ìƒíƒœ í™•ì¸
        kubectl get pods -n ${{ env.PROJECT_NAME }} -l app=${{ env.PROJECT_NAME }}-app
        
        # Service í™•ì¸
        kubectl get svc -n ${{ env.PROJECT_NAME }}
        
        # Deployment ìƒíƒœ í™•ì¸
        READY_REPLICAS=$(kubectl get deployment ${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }} -o jsonpath='{.status.readyReplicas}')
        DESIRED_REPLICAS=$(kubectl get deployment ${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }} -o jsonpath='{.spec.replicas}')
        
        echo "ì¤€ë¹„ëœ ë ˆí”Œë¦¬ì¹´: $READY_REPLICAS"
        echo "ì›í•˜ëŠ” ë ˆí”Œë¦¬ì¹´: $DESIRED_REPLICAS"
        
        if [ "$READY_REPLICAS" = "$DESIRED_REPLICAS" ]; then
          echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        else
          echo "âŒ ë°°í¬ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
          kubectl describe deployment ${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }}
          kubectl logs -l app=${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }} --tail=100
          exit 1
        fi
    
    # ===============================================
    # ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    # ===============================================
    - name: Application Deployment Notification
      if: success() && github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ‰ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì™„ë£Œ!"
        echo "í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
        echo "ì´ë¯¸ì§€: ${{ steps.build-image.outputs.image }}"
        echo "í´ëŸ¬ìŠ¤í„°: ${{ env.EKS_CLUSTER_NAME }}"
        echo "ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${{ env.PROJECT_NAME }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        echo "ë°°í¬ ì‹œê°„: $(date)"
        
        # ë°°í¬ëœ ì„œë¹„ìŠ¤ ì •ë³´ ì¶œë ¥
        kubectl get all -n ${{ env.PROJECT_NAME }}

    # ===============================================
    # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
    # ===============================================
    - name: Rollback on failure
      if: failure() && github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "âŒ ë°°í¬ ì‹¤íŒ¨ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°± ì¤‘..."
        kubectl rollout undo deployment/${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }}
        kubectl rollout status deployment/${{ env.PROJECT_NAME }}-app -n ${{ env.PROJECT_NAME }} --timeout=300s
        echo "âœ… ë¡¤ë°± ì™„ë£Œ"

    - name: Apply Database Schema
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì ìš© ì¤‘..."
        
        # RDS ì—”ë“œí¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
        RDS_ENDPOINT=$(aws rds describe-db-instances --query 'DBInstances[?DBName==`mydb`].Endpoint.Address' --output text 2>/dev/null || echo '')
        
        if [ -n "$RDS_ENDPOINT" ]; then
          echo "RDS ì—”ë“œí¬ì¸íŠ¸: $RDS_ENDPOINT"
          
          # ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì ìš© (PostgreSQL í´ë¼ì´ì–¸íŠ¸ ì„¤ì¹˜ í›„)
          sudo apt-get update && sudo apt-get install -y postgresql-client
          
          # ìŠ¤í‚¤ë§ˆ ì ìš©
          PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql \
            -h "$RDS_ENDPOINT" \
            -p 5432 \
            -U dbadmin \
            -d mydb \
            -f server/files/schema.sql \
            -v ON_ERROR_STOP=1
            
          echo "âœ… ìŠ¤í‚¤ë§ˆ ì ìš© ì™„ë£Œ"
        else
          echo "âŒ RDS ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        fi