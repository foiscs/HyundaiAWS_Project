# .github/workflows/deploy-infra.yml
# ì¸í”„ë¼ ë°°í¬ ì›Œí¬í”Œë¡œìš° (Terraform ë³€ê²½ì‹œë§Œ ì‹¤í–‰)

name: Deploy Infrastructure

on:
  push:
    branches: [ main, terraform ]
    paths:
      - 'WALB/infrastructure/**'
  pull_request:
    branches: [ main, terraform ]
    paths:
      - 'WALB/infrastructure/**'

env:
  PROJECT_NAME: "WALB-app"
  TF_VERSION: "1.5.0"

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    # ì›Œí‚¹ ë””ë ‰í† ë¦¬ë¥¼ WALBë¡œ ì„¤ì •
    defaults:
      run:
        working-directory: ./WALB/infrastructure/walb_terraform
    
    permissions:
      id-token: write
      contents: read

    steps:
    # ===============================================
    # ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
    # ===============================================
    - name: Checkout code
      uses: actions/checkout@v4

    # ===============================================
    # Terraform ì„¤ì •
    # ===============================================
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    # ===============================================
    # AWS ì¸ì¦ (OIDC ë°©ì‹)
    # ===============================================
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_INFRA }}
        aws-region: ${{ secrets.AWS_REGION }}
        role-session-name: GitHubActions-Infrastructure-${{ github.run_id }}

    # ===============================================
    # Terraform ì´ˆê¸°í™”
    # ===============================================
    - name: Terraform Init
      run: |
        echo "ğŸ”§ Terraform ì´ˆê¸°í™” ì¤‘..."
        terraform init
        echo "âœ… Terraform ì´ˆê¸°í™” ì™„ë£Œ"

    # ===============================================
    # Terraform í˜•ì‹ ê²€ì¦
    # ===============================================
    - name: Terraform Format Check
      run: |
        echo "ğŸ“ Terraform í˜•ì‹ ê²€ì¦ ì¤‘..."
        terraform fmt -check -recursive
        echo "âœ… í˜•ì‹ ê²€ì¦ ì™„ë£Œ"

    # ===============================================
    # Terraform ìœ íš¨ì„± ê²€ì¦
    # ===============================================
    - name: Terraform Validate
      run: |
        echo "ğŸ” Terraform êµ¬ì„± ê²€ì¦ ì¤‘..."
        terraform validate
        echo "âœ… êµ¬ì„± ê²€ì¦ ì™„ë£Œ"

    # ===============================================
    # Terraform Plan (PRì¼ ë•Œ)
    # ===============================================
    - name: Terraform Plan
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ“‹ Terraform Plan ì‹¤í–‰ ì¤‘..."
        terraform plan -no-color -out=tfplan
        echo "âœ… Plan ì‹¤í–‰ ì™„ë£Œ"

    # ===============================================
    # PR ì½”ë©˜íŠ¸ì— Plan ê²°ê³¼ ì¶”ê°€
    # ===============================================
    - name: Comment PR with Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const { execSync } = require('child_process');
          
          try {
            const planOutput = execSync('cd infrastructure/walb_terraform && terraform show -no-color tfplan', { encoding: 'utf8' });
            
            const comment = `## ğŸ—ï¸ Terraform Plan ê²°ê³¼
            
            ### ğŸ“‹ ë³€ê²½ ì‚¬í•­ ìš”ì•½
            \`\`\`
            ${planOutput.substring(0, 4000)}
            \`\`\`
            
            ### â„¹ï¸ ì¶”ê°€ ì •ë³´
            - **ì›Œí¬í”Œë¡œìš°**: Infrastructure Deploy
            - **í™˜ê²½**: ${process.env.PROJECT_NAME}
            - **ì»¤ë°‹**: ${context.sha.substring(0, 8)}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Plan ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
          }

    # ===============================================
    # Terraform Apply (main ë˜ëŠ” terraform ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
    # ===============================================
    - name: Terraform Apply
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/terraform') && github.event_name == 'push'
      run: |
        echo "ğŸš€ ì¸í”„ë¼ ë°°í¬ ì¤‘..."
        terraform apply -auto-approve
        echo "âœ… ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ"

    # ===============================================
    # ë°°í¬ ê²°ê³¼ í™•ì¸
    # ===============================================
    - name: Verify Infrastructure
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/terraform') && github.event_name == 'push'
      run: |
        echo "ğŸ” ë°°í¬ëœ ë¦¬ì†ŒìŠ¤ í™•ì¸ ì¤‘..."
        
        # VPC í™•ì¸
        VPC_ID=$(terraform output -raw vpc_id 2>/dev/null || echo "")
        if [ -n "$VPC_ID" ]; then
          echo "âœ… VPC: $VPC_ID"
        fi
        
        # EKS í´ëŸ¬ìŠ¤í„° í™•ì¸
        EKS_CLUSTER=$(terraform output -raw eks_cluster_name 2>/dev/null || echo "")
        if [ -n "$EKS_CLUSTER" ]; then
          echo "âœ… EKS Cluster: $EKS_CLUSTER"
          aws eks describe-cluster --name $EKS_CLUSTER --query 'cluster.status' --output text
        fi
        
        # RDS í™•ì¸
        RDS_ENDPOINT=$(terraform output -raw rds_endpoint 2>/dev/null || echo "")
        if [ -n "$RDS_ENDPOINT" ]; then
          echo "âœ… RDS Endpoint: $RDS_ENDPOINT"
        fi
        
        # S3 ë²„í‚· í™•ì¸
        S3_LOGS_BUCKET=$(terraform output -raw s3_logs_bucket_name 2>/dev/null || echo "")
        if [ -n "$S3_LOGS_BUCKET" ]; then
          echo "âœ… S3 Logs Bucket: $S3_LOGS_BUCKET"
        fi

    # ===============================================
    # ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    # ===============================================
    - name: Infrastructure Deployment Notification
      if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/terraform') && github.event_name == 'push'
      run: |
        echo "ğŸ‰ ì¸í”„ë¼ ë°°í¬ ì™„ë£Œ!"
        echo "í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
        echo "ë¦¬ì „: ${{ secrets.AWS_REGION }}"
        echo "ì»¤ë°‹: ${{ github.sha }}"
        echo "ë°°í¬ ì‹œê°„: $(date)"

    # ===============================================
    # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ì •ë³´ ì œê³µ
    # ===============================================
    - name: Rollback Information
      if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/terraform') && github.event_name == 'push'
      run: |
        echo "âŒ ì¸í”„ë¼ ë°°í¬ ì‹¤íŒ¨"
        echo "ë¡¤ë°±ì´ í•„ìš”í•œ ê²½ìš° ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
        echo "terraform plan -destroy"
        echo "terraform destroy"
        echo "ë˜ëŠ” ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë˜ëŒë¦° í›„ ë‹¤ì‹œ ë°°í¬í•˜ì„¸ìš”."