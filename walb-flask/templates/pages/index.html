{% extends "base.html" %} {% block title %}WALB ëŒ€ì‹œë³´ë“œ{% endblock %} {% block extra_css %}
<style>
    /* Pretendard í°íŠ¸ ì„í¬íŠ¸ */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

    .floating-elements {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
        overflow: hidden;
    }

    .floating-circle {
        position: absolute;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        animation: float-circle 6s ease-in-out infinite;
    }

    .circle-1 {
        width: 60px;
        height: 60px;
        top: 20%;
        right: 10%;
        animation-delay: 0s;
    }

    .circle-2 {
        width: 40px;
        height: 40px;
        top: 60%;
        right: 20%;
        animation-delay: 2s;
    }

    .circle-3 {
        width: 80px;
        height: 80px;
        top: 10%;
        right: 40%;
        animation-delay: 4s;
    }

    @keyframes float {
        0%,
        100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    @keyframes float-circle {
        0%,
        100% {
            transform: translateY(0px) rotate(0deg);
            opacity: 0.1;
        }
        50% {
            transform: translateY(-20px) rotate(180deg);
            opacity: 0.2;
        }
    }
</style>
{% endblock %} {% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-8 text-white mb-8 relative overflow-hidden">
    <div class="relative z-10">
        <div class="flex items-center mb-4">
            <span class="text-4xl mr-4 animate-bounce">ğŸ </span>
            <div>
                <h1 class="text-3xl font-bold mb-2">ë©€í‹° í´ë¼ìš°ë“œ ë³´ì•ˆ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-blue-100">Terraform & boto3 í•˜ì´ë¸Œë¦¬ë“œ IaC ìë™í™” + Kinesis & Splunk í†µí•© ëª¨ë‹ˆí„°ë§</p>
            </div>
        </div>
    </div>

    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 right-10 w-20 h-20 bg-white rounded-full animate-pulse"></div>
        <div class="absolute bottom-10 right-20 w-16 h-16 bg-white rounded-full animate-pulse delay-1000"></div>
        <div class="absolute top-20 left-20 w-12 h-12 bg-white rounded-full animate-pulse delay-2000"></div>
    </div>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <div class="flex items-center">
            <div class="p-3 bg-blue-100 rounded-lg">
                <span class="text-2xl">â˜ï¸</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-600">ì´ ê³„ì •</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.total_accounts }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <div class="flex items-center">
            <div class="p-3 bg-green-100 rounded-lg">
                <span class="text-2xl">âœ…</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-600">í™œì„± ê³„ì •</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.active_accounts }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <div class="flex items-center">
            <div class="p-3 bg-purple-100 rounded-lg">
                <span class="text-2xl">ğŸ›¡ï¸</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-600">Role ê¸°ë°˜</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.role_based }}</p>
            </div>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border">
        <div class="flex items-center">
            <div class="p-3 bg-orange-100 rounded-lg">
                <span class="text-2xl">ğŸ”‘</span>
            </div>
            <div class="ml-4">
                <p class="text-sm text-gray-600">Key ê¸°ë°˜</p>
                <p class="text-2xl font-bold text-gray-900">{{ stats.key_based }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="flex gap-4 mb-8">
    <a href="{{ url_for('connection.index') }}" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"> â• ìƒˆ AWS ê³„ì • ì¶”ê°€ </a>
    <button onclick="location.reload()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    <button onclick="testAllConnections()" id="test-connections-btn" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium">
        <span id="test-btn-text">ğŸ” ì—°ê²° ìƒíƒœ í™•ì¸</span>
        <span id="test-btn-spinner" class="hidden">â³ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</span>
    </button>
</div>

<!-- Accounts Section -->
<div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900">â˜ï¸ ì—°ê²°ëœ AWS ê³„ì •</h2>
        <span class="text-sm text-gray-500">ì´ {{ accounts|length }}ê°œ</span>
    </div>

    {% if accounts %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for account in accounts %}
        <div class="border rounded-lg p-6 hover:shadow-md transition-shadow">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <span class="text-xl mr-3">â˜ï¸</span>
                    <h3 class="font-semibold text-gray-900">{{ account.cloud_name }}</h3>
                </div>
                <span id="status-{{ account.account_id }}-{{ account.cloud_name }}" class="text-xs px-2 py-1 rounded-full {% if account.status == 'active' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %}">
                    {% if account.status == 'active' %}ì—°ê²°ë¨{% else %}ì—°ê²°ì‹¤íŒ¨{% endif %}
                </span>
            </div>

            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-600">ê³„ì • ID</p>
                    <p class="font-medium">{{ account.account_id }}</p>
                </div>
                <div>
                    <p class="text-gray-600">ë¦¬ì „</p>
                    <p class="font-medium">{{ account.primary_region }}</p>
                </div>
                <div>
                    <p class="text-gray-600">ì—°ê²° ë°©ì‹</p>
                    <p class="font-medium">{{ account.connection_display_name }}</p>
                </div>
                <div>
                    <p class="text-gray-600">ë‹´ë‹¹ì</p>
                    <p class="font-medium">{{ account.contact_email }}</p>
                </div>
            </div>

            <div class="flex gap-2 mt-4" id="actions-{{ account.account_id }}-{{ account.cloud_name }}">
                {% if account.status == 'active' %}
                <button onclick="window.location.href='{{ url_for('diagnosis.index') }}?account={{ account.account_id }}'" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">ğŸ›¡ï¸ ë³´ì•ˆ ì§„ë‹¨</button>
                <button onclick="window.location.href='{{ url_for('monitoring.index') }}?account={{ account.account_id }}'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium">ğŸ“Š ëª¨ë‹ˆí„°ë§</button>
                {% else %}
                <button disabled class="flex-1 px-4 py-2 bg-gray-400 text-gray-600 rounded-lg cursor-not-allowed text-sm font-medium">âš ï¸ ì¬ì—°ê²° í•„ìš”</button>
                <button disabled class="px-4 py-2 bg-gray-400 text-gray-600 rounded-lg cursor-not-allowed text-sm font-medium">âš ï¸ ì¬ì—°ê²° í•„ìš”</button>
                {% endif %}
                <button onclick="editConnection('{{ account.account_id }}', '{{ account.cloud_name }}')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium">âš™ï¸ ìˆ˜ì •</button>
                <button onclick="deleteAccount('{{ account.account_id }}', '{{ account.cloud_name }}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-6xl mb-4">â˜ï¸</div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">ì—°ê²°ëœ AWS ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
        <p class="text-gray-600 mb-6">WALB ë³´ì•ˆ ê´€ë¦¬ë¥¼ ì‹œì‘í•˜ë ¤ë©´ AWS ê³„ì •ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”</p>
        <a href="{{ url_for('connection.index') }}" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"> â• ì²« ë²ˆì§¸ ê³„ì • ì—°ê²° </a>
    </div>
    {% endif %}
</div>

<!-- Project Info Section -->
<div class="bg-white rounded-xl shadow-sm border p-6">
    <div class="flex items-center mb-6">
        <span class="text-2xl mr-3">ğŸ”</span>
        <h2 class="text-xl font-bold text-gray-900">WALB í”„ë¡œì íŠ¸ ì†Œê°œ</h2>
    </div>

    <p class="text-gray-700 mb-6"><strong>WALB(Well-Architected AWS Security Lab)</strong>ëŠ” í´ë¼ìš°ë“œ ë³´ì•ˆ ê°€ì´ë“œë¼ì¸ì„ ê¸°ë°˜ìœ¼ë¡œ AWS í™˜ê²½ì˜ ë³´ì•ˆ ì§„ë‹¨, ìë™ ì¡°ì¹˜, ëª¨ë‹ˆí„°ë§ ë° ì•ˆì „í•œ ì¸í”„ë¼ êµ¬ì¶•ì„ ìˆ˜í–‰í•˜ëŠ” í†µí•© ë³´ì•ˆ ê´€ë¦¬ í”Œë«í¼ì…ë‹ˆë‹¤.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                <span class="text-lg mr-2">ğŸ¯</span>
                ì£¼ìš” ê¸°ëŠ¥
            </h3>
            <ul class="space-y-2 text-sm text-gray-600">
                <li class="flex items-start">
                    <span class="text-green-500 mr-2">âœ“</span>
                    <span>41ê°œ ë³´ì•ˆ í•­ëª© ìë™ ì§„ë‹¨ ë° ì‹¤ì‹œê°„ ì¡°ì¹˜</span>
                </li>
                <li class="flex items-start">
                    <span class="text-green-500 mr-2">âœ“</span>
                    <span>Terraform + tfsec ê¸°ë°˜ ì•ˆì „í•œ IaC ì¸í”„ë¼ êµ¬ì¶•</span>
                </li>
                <li class="flex items-start">
                    <span class="text-green-500 mr-2">âœ“</span>
                    <span>Splunk + Kinesis í†µí•© ì‹¤ì‹œê°„ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§</span>
                </li>
                <li class="flex items-start">
                    <span class="text-green-500 mr-2">âœ“</span>
                    <span>GuardDuty, CloudTrail ì—°ê³„ ìœ„í˜‘ íƒì§€</span>
                </li>
                <li class="flex items-start">
                    <span class="text-green-500 mr-2">âœ“</span>
                    <span>Cross-Account Role ê¸°ë°˜ ì•ˆì „í•œ ë©€í‹° ê³„ì • ê´€ë¦¬</span>
                </li>
            </ul>
        </div>

        <div>
            <h3 class="font-semibold text-gray-900 mb-3 flex items-center">
                <span class="text-lg mr-2">ğŸ› ï¸</span>
                ê¸°ìˆ  ìŠ¤íƒ
            </h3>
            <ul class="space-y-2 text-sm text-gray-600">
                <li class="flex items-start">
                    <span class="text-blue-500 mr-2">â–¶</span>
                    <span><strong>Backend:</strong> Flask, boto3, SQLite</span>
                </li>
                <li class="flex items-start">
                    <span class="text-blue-500 mr-2">â–¶</span>
                    <span><strong>Frontend:</strong> Tailwind CSS, Vanilla JS</span>
                </li>
                <li class="flex items-start">
                    <span class="text-blue-500 mr-2">â–¶</span>
                    <span><strong>IaC:</strong> Terraform, tfsec (ë³´ì•ˆ ê²€ì¦)</span>
                </li>
                <li class="flex items-start">
                    <span class="text-blue-500 mr-2">â–¶</span>
                    <span><strong>Monitoring:</strong> Splunk, Kinesis, CloudWatch, CloudTrail, GuardDuty</span>
                </li>
                <li class="flex items-start">
                    <span class="text-blue-500 mr-2">â–¶</span>
                    <span><strong>Security:</strong> IAM ìµœì†Œ ê¶Œí•œ, Cross-Account Role</span>
                </li>
            </ul>
        </div>
    </div>

    <div class="mt-6 p-4 bg-blue-50 rounded-lg">
        <p class="text-sm text-blue-800"><strong>ğŸ’¡ Tip:</strong> ì¢Œì¸¡ ìƒë‹¨ì˜ "â• ìƒˆ AWS ê³„ì • ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì²« ë²ˆì§¸ AWS ê³„ì •ì„ ì—°ê²°í•˜ê³ , ë³´ì•ˆ ì§„ë‹¨ì„ ì‹œì‘í•´ë³´ì„¸ìš”. <br />ëª¨ë“  ì§„ë‹¨ ê²°ê³¼ëŠ” ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥í•˜ë©°, ìœ„í—˜í•œ ì„¤ì •ì€ ì¦‰ì‹œ ìë™ ì¡°ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    // ì‹¤ì‹œê°„ ì‹œê°„ ì—…ë°ì´íŠ¸
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleString('ko-KR');
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }

    // ì‚¬ì´ë“œë°” í†µê³„ ì—…ë°ì´íŠ¸
    function updateSidebarStats() {
        const totalElement = document.getElementById('total-accounts');
        const activeElement = document.getElementById('active-accounts');
        if (totalElement) totalElement.textContent = '{{ stats.total_accounts }}';
        if (activeElement) activeElement.textContent = '{{ stats.active_accounts }}';
    }

    // ëª¨ë“  ê³„ì • ì—°ê²° ìƒíƒœ í…ŒìŠ¤íŠ¸
    async function testAllConnections() {
        const btn = document.getElementById('test-connections-btn');
        const btnText = document.getElementById('test-btn-text');
        const btnSpinner = document.getElementById('test-btn-spinner');

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        btn.disabled = true;
        btnText.classList.add('hidden');
        btnSpinner.classList.remove('hidden');

        try {
            const response = await fetch('/api/test-all-connections', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            const result = await response.json();

            if (result.success) {
                let successCount = 0;
                let failedCount = 0;

                // ê° ê³„ì •ì˜ ìƒíƒœë¥¼ UIì— ì—…ë°ì´íŠ¸í•˜ê³  ì‹¤íŒ¨í•œ ê³„ì •ë“¤ ì¶”ì 
                Object.values(result.results).forEach((account) => {
                    updateAccountStatus(account.account_id, account.cloud_name, account.new_status, account.status_message);
                    updateAccountActions(account.account_id, account.cloud_name, account.new_status);

                    if (account.test_success) {
                        successCount++;
                    } else {
                        failedCount++;
                        // ì‹¤íŒ¨í•œ ê³„ì •ì— ëŒ€í•´ ê°œë³„ í† ìŠ¤íŠ¸ í‘œì‹œ
                        showFailureToast(account.cloud_name, account.account_id, account.error_message);
                    }
                });

                // ì „ì²´ ê²°ê³¼ ìš”ì•½ ë©”ì‹œì§€
                if (failedCount === 0) {
                    showNotification('success', `âœ… ëª¨ë“  ê³„ì • ì—°ê²° ì„±ê³µ (${successCount}ê°œ)`);
                } else {
                    showNotification('warning', `âš ï¸ ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failedCount}ê°œ`);
                }

                // 3ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (í†µê³„ ì—…ë°ì´íŠ¸)
                setTimeout(() => {
                    location.reload();
                }, 5000);
            } else {
                showNotification('error', `ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${result.error}`);
            }
        } catch (error) {
            console.error('Connection test error:', error);
            showNotification('error', 'ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
            // ë²„íŠ¼ ìƒíƒœ ë³µì›
            btn.disabled = false;
            btnText.classList.remove('hidden');
            btnSpinner.classList.add('hidden');
        }
    }

    // ê°œë³„ ê³„ì • ìƒíƒœ UI ì—…ë°ì´íŠ¸
    function updateAccountStatus(accountId, cloudName, status, statusMessage) {
        const statusElement = document.getElementById(`status-${accountId}-${cloudName}`);
        if (statusElement) {
            // í´ë˜ìŠ¤ ì´ˆê¸°í™”
            statusElement.className = 'text-xs px-2 py-1 rounded-full';

            // ìƒíƒœì— ë”°ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            if (status === 'active') {
                statusElement.classList.add('bg-green-100', 'text-green-700');
            } else {
                statusElement.classList.add('bg-red-100', 'text-red-700');
            }

            statusElement.textContent = statusMessage;
        }
    }

    // ê°œë³„ ê³„ì • ì•¡ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
    function updateAccountActions(accountId, cloudName, status) {
        const actionsElement = document.getElementById(`actions-${accountId}-${cloudName}`);
        if (actionsElement) {
            if (status === 'active') {
                // ì—°ê²° ì„±ê³µ ì‹œ í™œì„±í™”ëœ ë²„íŠ¼ë“¤
                actionsElement.innerHTML = `
                    <button onclick="window.location.href='/diagnosis?account=${accountId}'" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium">ğŸ›¡ï¸ ë³´ì•ˆ ì§„ë‹¨</button>
                    <button onclick="window.location.href='/monitoring?account=${accountId}'" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors text-sm font-medium">ğŸ“Š ëª¨ë‹ˆí„°ë§</button>
                    <button onclick="editConnection('${accountId}', '${cloudName}')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium">âš™ï¸ ìˆ˜ì •</button>
                    <button onclick="deleteAccount('${accountId}', '${cloudName}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">ğŸ—‘ï¸ ì‚­ì œ</button>
                `;
            } else {
                // ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¹„í™œì„±í™”ëœ ë²„íŠ¼ë“¤
                actionsElement.innerHTML = `
                    <button disabled class="flex-1 px-4 py-2 bg-gray-400 text-gray-600 rounded-lg cursor-not-allowed text-sm font-medium">âš ï¸ ì¬ì—°ê²° í•„ìš”</button>
                    <button disabled class="px-4 py-2 bg-gray-400 text-gray-600 rounded-lg cursor-not-allowed text-sm font-medium">âš ï¸ ì¬ì—°ê²° í•„ìš”</button>
                    <button onclick="editConnection('${accountId}', '${cloudName}')" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors text-sm font-medium">âš™ï¸ ìˆ˜ì •</button>
                    <button onclick="deleteAccount('${accountId}', '${cloudName}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium">ğŸ—‘ï¸ ì‚­ì œ</button>
                `;
            }
        }
    }

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    function showNotification(type, message) {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existing = document.getElementById('notification');
        if (existing) {
            existing.remove();
        }

        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg max-w-md ${type === 'success' ? 'bg-green-500 text-white' : type === 'warning' ? 'bg-yellow-500 text-white' : 'bg-red-500 text-white'}`;
        notification.innerHTML = `
            <div class="flex items-center">
                <span class="mr-2">${type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'âŒ'}</span>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">Ã—</button>
            </div>
        `;

        document.body.appendChild(notification);

        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // ì—°ê²° ì‹¤íŒ¨í•œ ê³„ì •ì— ëŒ€í•œ ê°œë³„ í† ìŠ¤íŠ¸ í‘œì‹œ
    function showFailureToast(cloudName, accountId, errorMessage) {
        // ì‹¤íŒ¨ í† ìŠ¤íŠ¸ ìƒì„±
        const toastId = `failure-toast-${accountId}-${Date.now()}`;
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = 'fixed top-20 right-4 z-40 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg max-w-sm mb-2';
        toast.style.marginTop = `${document.querySelectorAll('[id^="failure-toast-"]').length * 60}px`;

        // ì—ëŸ¬ ë©”ì‹œì§€ ì •ë¦¬ (ë„ˆë¬´ ê¸¸ë©´ ì¤„ì„)
        let displayError = errorMessage || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
        if (displayError.length > 100) {
            displayError = displayError.substring(0, 100) + '...';
        }

        toast.innerHTML = `
            <div class="text-sm">
                <div class="font-semibold mb-1">âŒ ì—°ê²° ì‹¤íŒ¨: ${cloudName}</div>
                <div class="text-xs opacity-90">ê³„ì • ID: ${accountId}</div>
                <div class="text-xs opacity-90 mt-1">${displayError}</div>
                <button onclick="this.parentElement.parentElement.remove()" class="absolute top-1 right-2 text-white hover:text-gray-200 text-lg">Ã—</button>
            </div>
        `;

        document.body.appendChild(toast);

        // 10ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 10000);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    async function autoTestConnections() {
        // ê³„ì •ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        const accountElements = document.querySelectorAll('[id^="status-"]');
        if (accountElements.length > 0) {
            console.log('í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');

            // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë¹„í™œì„±í™”
            const btn = document.getElementById('test-connections-btn');
            const btnText = document.getElementById('test-btn-text');
            const btnSpinner = document.getElementById('test-btn-spinner');

            if (btn && btnText && btnSpinner) {
                btn.disabled = true;
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
            }

            // ìë™ í…ŒìŠ¤íŠ¸ì‹œì—ëŠ” í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì—†ì´ ë°”ë¡œ ì‹¤í–‰
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/test-all-connections', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });

                    const result = await response.json();

                    if (result.success) {
                        let successCount = 0;
                        let failedCount = 0;

                        // ê° ê³„ì •ì˜ ìƒíƒœë¥¼ UIì— ì—…ë°ì´íŠ¸í•˜ê³  ì‹¤íŒ¨í•œ ê³„ì •ë“¤ ì¶”ì 
                        Object.values(result.results).forEach((account) => {
                            updateAccountStatus(account.account_id, account.cloud_name, account.new_status, account.status_message);
                            updateAccountActions(account.account_id, account.cloud_name, account.new_status);

                            if (account.test_success) {
                                successCount++;
                            } else {
                                failedCount++;
                                // ì‹¤íŒ¨í•œ ê³„ì •ì— ëŒ€í•´ ê°œë³„ í† ìŠ¤íŠ¸ í‘œì‹œ (ìë™ í…ŒìŠ¤íŠ¸)
                                showFailureToast(account.cloud_name, account.account_id, account.error_message);
                            }
                        });

                        // ìë™ í…ŒìŠ¤íŠ¸ ì™„ë£Œ ë©”ì‹œì§€ (ëœ ì¹¨í•´ì )
                        if (failedCount > 0) {
                            console.log(`ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ: ì„±ê³µ ${successCount}ê°œ, ì‹¤íŒ¨ ${failedCount}ê°œ`);
                        }
                    } else {
                        console.error('Auto connection test failed:', result.error);
                        showNotification('error', `ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Auto connection test failed:', error);
                    showNotification('error', 'ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                } finally {
                    // í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ë³µì›
                    const btn = document.getElementById('test-connections-btn');
                    const btnText = document.getElementById('test-btn-text');
                    const btnSpinner = document.getElementById('test-btn-spinner');

                    if (btn && btnText && btnSpinner) {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                    }
                }
            }, 3000);
        }
    }

    // AWS ê³„ì • ì‚­ì œ í•¨ìˆ˜
    async function deleteAccount(accountId, cloudName) {
        // í™•ì¸ ëª¨ë‹¬
        const confirmed = confirm(`ì •ë§ë¡œ "${cloudName}" (${accountId}) ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);

        if (!confirmed) {
            return;
        }

        try {
            const response = await fetch('/api/accounts/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    account_id: accountId,
                    cloud_name: cloudName,
                }),
            });

            const result = await response.json();

            if (result.success) {
                // ì„±ê³µ ë©”ì‹œì§€
                showNotification('success', `"${cloudName}" ê³„ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                // ì‹¤íŒ¨ ë©”ì‹œì§€
                showNotification('error', `ê³„ì • ì‚­ì œ ì‹¤íŒ¨: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
            }
        } catch (error) {
            console.error('Delete account error:', error);
            showNotification('error', 'ê³„ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // AWS ê³„ì • ì—°ê²° ìˆ˜ì • í•¨ìˆ˜
    function editConnection(accountId, cloudName) {
        // ì—°ê²° ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ (3ë‹¨ê³„ë¶€í„° ì‹œì‘í•˜ëŠ” ìˆ˜ì • ëª¨ë“œ)
        window.location.href = `/connection?mode=edit&account=${accountId}&name=${encodeURIComponent(cloudName)}`;
    }

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function () {
        updateTime();
        updateSidebarStats();
        setInterval(updateTime, 1000);

        // ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        autoTestConnections();
    });
</script>
{% endblock %}
