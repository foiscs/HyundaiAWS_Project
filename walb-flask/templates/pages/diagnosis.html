{% extends "base.html" %} {% set page_title = "ë³´ì•ˆ ì§„ë‹¨" %} {% block title %}{{ page_title }}{% endblock %} {% block content %}
<!-- íˆì–´ë¡œ í—¤ë” -->
<div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-8 text-white mb-8 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center mb-4">
                        <span class="text-4xl mr-4 animate-bounce">ğŸ”</span>
                        <div>
                            <h1 class="text-3xl font-bold mb-2">AWS ì¸í”„ë¼ ì¢…í•© ë³´ì•ˆ ì§„ë‹¨ & ìë™ ì¡°ì¹˜</h1>
                            <p class="text-purple-100">ì´ 41ê°œ í•­ëª© ì™„ì „ ìë™í™” (KISA ISMS-P 31ê°œ ì ê²€ í•­ëª© + 2024 SK Shieldus í´ë¼ìš°ë“œ ë³´ì•ˆ ê°€ì´ë“œë¼ì¸ 10ê°œ)</p>
                        </div>
                    </div>
                </div>

                <!-- Background Pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-10 right-10 w-20 h-20 bg-white rounded-full animate-pulse"></div>
                    <div class="absolute bottom-10 right-20 w-16 h-16 bg-white rounded-full animate-pulse delay-1000"></div>
                    <div class="absolute top-20 left-20 w-12 h-12 bg-white rounded-full animate-pulse delay-2000"></div>
                </div>
            </div>

            <!-- ê³„ì • ì„ íƒ ì„¹ì…˜ -->
            <div class="account-selection-section">
                <h2 class="section-title">
                    <span class="section-icon">â˜ï¸</span>
                    ì—°ê²°ëœ AWS ê³„ì •
                </h2>

                {% if accounts %}
                <div class="accounts-grid">
                    {% for account in accounts %}
                    <div class="account-card {% if selected_account and selected_account.account_id == account.account_id %}selected{% endif %}" data-account-id="{{ account.account_id }}" onclick="selectAccount('{{ account.account_id }}')">
                        <div class="account-header">
                            <h3 class="account-name">{{ account.cloud_name }}</h3>
                            <div class="account-type-badge">
                                {% if account.connection_type == 'role' %}
                                <span class="badge badge-role">Role</span>
                                {% else %}
                                <span class="badge badge-key">Key</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="account-details">
                            <div class="account-detail">
                                <span class="detail-label">ê³„ì • ID</span>
                                <span class="detail-value">{{ account.account_id }}</span>
                            </div>
                            <div class="account-detail">
                                <span class="detail-label">ë¦¬ì „</span>
                                <span class="detail-value">{{ account.primary_region }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">ğŸ“‹</div>
                    {% if failed_accounts_count > 0 %}
                    <h3>ì§„ë‹¨ ê°€ëŠ¥í•œ AWS ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë³´ì•ˆ ì§„ë‹¨ì„ ìœ„í•´ì„œëŠ” AWS ê³„ì •ì´ ì—°ê²°ëœ ìƒíƒœì—¬ì•¼ í•©ë‹ˆë‹¤.</p>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <span class="text-yellow-600 text-lg mr-3">âš ï¸</span>
                            <div class="text-sm text-yellow-800">
                                <strong>{{ failed_accounts_count }}ê°œ ê³„ì •ì˜ ì—°ê²°ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</strong><br>
                                <a href="{{ url_for('main.index') }}" class="text-blue-600 hover:underline">ë©”ì¸ í˜ì´ì§€</a>ì—ì„œ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <h3>ë“±ë¡ëœ AWS ê³„ì •ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p>ë³´ì•ˆ ì§„ë‹¨ì„ ì‹œì‘í•˜ë ¤ë©´ ë¨¼ì € AWS ê³„ì •ì„ ì—°ê²°í•´ì£¼ì„¸ìš”.</p>
                    {% endif %}
                    <a href="{{ url_for('connection.index') }}" class="btn btn-primary"> <span>ğŸ’«</span> AWS ê³„ì • ì—°ê²°í•˜ê¸° </a>
                </div>
                {% endif %}
            </div>

            <!-- ì§„ë‹¨ ì œì–´ íŒ¨ë„ -->
            {% if selected_account %}
            <div class="diagnosis-control-panel" id="controlPanel" style="display: none">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span class="panel-icon">ğŸ”</span>
                        ë³´ì•ˆ ì§„ë‹¨ ì œì–´íŒ
                    </h2>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" onclick="testConnection()"><span>ğŸ”—</span> ì—°ê²° í…ŒìŠ¤íŠ¸</button>
                        <button class="btn btn-primary" onclick="runAllDiagnosis()"><span>ğŸš€</span> ì „ì²´ ì§„ë‹¨ ì‹œì‘</button>
                    </div>
                </div>

                <!-- ì§„ë‹¨ í†µê³„ -->
                <div class="diagnosis-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-content">
                            <div class="stat-number">41</div>
                            <div class="stat-label">ì „ì²´ í•­ëª©</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”´</div>
                        <div class="stat-content">
                            <div class="stat-number">16</div>
                            <div class="stat-label">ìƒìœ„í—˜</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸŸ¡</div>
                        <div class="stat-content">
                            <div class="stat-number">22</div>
                            <div class="stat-label">ì¤‘ìœ„í—˜</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸŸ¢</div>
                        <div class="stat-content">
                            <div class="stat-number">3</div>
                            <div class="stat-label">ì €ìœ„í—˜</div>
                        </div>
                    </div>
                </div>
                
                <!-- ì§„ë‹¨ ì•ˆë‚´ë¬¸êµ¬ -->
                <div class="diagnosis-guide">
                    <div class="guide-content">
                        <div class="guide-icon">ğŸ’¡</div>
                        <div class="guide-text">
                            <strong>ì§„ë‹¨ ì•ˆì •ì„± ì•ˆë‚´:</strong> AWS API ì‘ë‹µ ì§€ì—°ìœ¼ë¡œ ì¸í•´ ì¼ë¶€ ì§„ë‹¨ í•­ëª©ì´ ê°„í—ì ìœ¼ë¡œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
                            ì‹¤íŒ¨ ì‹œ ê°œë³„ ì¬ì§„ë‹¨ ë˜ëŠ” ì „ì²´ ì¬ì§„ë‹¨ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”. (íƒ€ì„ì•„ì›ƒ: 60ì´ˆ)
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì§„ë‹¨ ê²°ê³¼ ëŒ€ì‹œë³´ë“œ -->
            <div class="diagnosis-results-dashboard" id="resultsDashboard" style="display: none;">
                <h2 class="dashboard-title">
                    <span class="dashboard-icon">ğŸ“Š</span>
                    ì§„ë‹¨ ê²°ê³¼ ìš”ì•½
                </h2>
                
                <div class="results-grid">
                    <!-- ì´ ì§„ë‹¨ í•­ëª© -->
                    <div class="result-card total-card">
                        <div class="result-icon">ğŸ“‹</div>
                        <div class="result-content">
                            <div class="result-number" id="totalScanned">0</div>
                            <div class="result-label">ì§„ë‹¨ ì™„ë£Œ</div>
                            <div class="result-percentage">ì „ì²´ 41ê°œ ì¤‘</div>
                        </div>
                    </div>
                    
                    <!-- ì·¨ì•½ í•­ëª© -->
                    <div class="result-card vulnerable-card">
                        <div class="result-icon">âš ï¸</div>
                        <div class="result-content">
                            <div class="result-number" id="vulnerableCount">0</div>
                            <div class="result-label">ì·¨ì•½</div>
                            <div class="result-percentage" id="vulnerablePercentage">0%</div>
                        </div>
                    </div>
                    
                    <!-- ì•ˆì „ í•­ëª© -->
                    <div class="result-card safe-card">
                        <div class="result-icon">âœ…</div>
                        <div class="result-content">
                            <div class="result-number" id="safeCount">0</div>
                            <div class="result-label">ì•ˆì „</div>
                            <div class="result-percentage" id="safePercentage">0%</div>
                        </div>
                    </div>
                    
                    <!-- ìœ„í—˜ë„ë³„ ë¶„í¬ -->
                    <div class="result-card risk-distribution-card">
                        <div class="distribution-header">
                            <span class="distribution-title">ìœ„í—˜ë„ ë¶„í¬</span>
                        </div>
                        <div class="distribution-content">
                            <div class="risk-item">
                                <span class="risk-label">ğŸ”´ ìƒìœ„í—˜</span>
                                <span class="risk-count" id="highRiskCount">0</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">ğŸŸ¡ ì¤‘ìœ„í—˜</span>
                                <span class="risk-count" id="mediumRiskCount">0</span>
                            </div>
                            <div class="risk-item">
                                <span class="risk-label">ğŸŸ¢ ì €ìœ„í—˜</span>
                                <span class="risk-count" id="lowRiskCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ì•ˆì „ë¥  ë°” -->
                <div class="progress-bar-container">
                    <div class="progress-bar-header">
                        <span>ì „ì²´ ì•ˆì „ë¥ </span>
                        <span id="safetyRate">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="safetyBarFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- ì§„ë‹¨ í•­ëª© ì„¹ì…˜ -->
            {% if selected_account and sk_items %}
            <div class="diagnosis-items-section" id="diagnosisItems" style="display: none">
                <h2 class="section-title">
                    <span class="section-icon">ğŸ“‹</span>
                    ì§„ë‹¨ í•­ëª© ëª©ë¡
                </h2>

                {% for category, items in sk_items.items() %}
                <div class="category-section">
                    <div class="category-header">
                        <h3 class="category-title">{{ category }}</h3>
                        <div class="category-meta">
                            <span class="item-count">{{ items|length }}ê°œ í•­ëª©</span>
                        </div>
                    </div>

                    <div class="items-grid">
                        {% for item in items %}
                        <div class="diagnosis-item {% if not item.implemented %}item-not-implemented{% endif %}" data-item-code="{{ item.code }}" data-category="{{ category }}">
                            <div class="item-header">
                                <div class="item-code">{{ item.code }}</div>
                                <div class="item-severity severity-{{ item.severity }}">{% if item.severity == 'ìƒ' %}ğŸ”´{% elif item.severity == 'ì¤‘' %}ğŸŸ¡{% else %}ğŸŸ¢{% endif %} {{ item.severity }}</div>
                                {% if not item.implemented %}
                                <div class="item-implementation-status">
                                    <span class="badge badge-not-implemented">ë¯¸êµ¬í˜„</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="item-content">
                                <h4 class="item-name">{{ item.name }}</h4>
                                <p class="item-description">{{ item.description }}</p>
                                {% if not item.implemented %}
                                <p class="item-note">â€» í˜„ì¬ ê°œë°œ ì¤‘ì¸ ê¸°ëŠ¥ì…ë‹ˆë‹¤.</p>
                                {% endif %}
                            </div>
                            <div class="item-actions">
                                {% if item.implemented %}
                                <button class="btn btn-sm btn-primary" onclick="runSingleDiagnosis('{{ item.code }}')"><span>ğŸ”</span> ì§„ë‹¨ ì‹¤í–‰</button>
                                <div class="item-status" id="status-{{ item.code }}">
                                    <span class="status-badge status-idle">ëŒ€ê¸°</span>
                                </div>
                                {% else %}
                                <button class="btn btn-sm btn-disabled" disabled><span>ğŸš§</span> ê°œë°œ ì¤‘</button>
                                <div class="item-status">
                                    <span class="status-badge status-not-implemented">ë¯¸êµ¬í˜„</span>
                                </div>
                                {% endif %}
                            </div>

                            <!-- ì§„ë‹¨ ê²°ê³¼ ì˜ì—­ -->
                            {% if item.implemented %}
                            <div class="diagnosis-result" id="result-{{ item.code }}" style="display: none">
                                <!-- ê²°ê³¼ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ í…œí”Œë¦¿ -->
            <div id="loadingTemplate" style="display: none">
                <div class="diagnosis-loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">ì§„ë‹¨ ì§„í–‰ ì¤‘...</div>
                </div>
            </div>

            <!-- ê²°ê³¼ í…œí”Œë¦¿ -->
            <div id="resultTemplate" style="display: none">
                <div class="result-header">
                    <div class="result-status-badge"></div>
                    <div class="result-timestamp"></div>
                </div>
                <div class="result-content">
                    <!-- ê²°ê³¼ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>
                <div class="result-actions">
                    <button class="btn btn-sm btn-secondary" onclick="rediagnose(this)"><span>ğŸ”„</span> ì¬ì§„ë‹¨</button>
                </div>
            </div>

            <script>
                let selectedAccountId = null;
                let diagnosisInProgress = false;
                let diagnosisResults = {
                    total: 0,
                    vulnerable: 0,
                    safe: 0,
                    highRisk: 0,
                    mediumRisk: 0,
                    lowRisk: 0
                };

                // í‚¤ë¥¼ ì‚¬ìš©ì ì¹œí™”ì  ì´ë¦„ìœ¼ë¡œ ë³€í™˜
                function convertKeyToFriendlyName(key) {
                    const keyMap = {
                        'message': 'ë©”ì‹œì§€',
                        'summary': 'ìš”ì•½',
                        'total_users': 'ì „ì²´ ì‚¬ìš©ì',
                        'admin_users': 'ê´€ë¦¬ì ê¶Œí•œ ì‚¬ìš©ì',
                        'test_users': 'í…ŒìŠ¤íŠ¸/ì„ì‹œ ê³„ì •',
                        'vulnerable_nacls': 'ì·¨ì•½í•œ ë„¤íŠ¸ì›Œí¬ ACL',
                        'misconfigured_routes': 'ì˜ëª»ëœ ê²½ë¡œ ì„¤ì •',
                        'insecure_buckets': 'ë³´ì•ˆ ì„¤ì • ë¶€ì¡± S3 ë²„í‚·',
                        'unencrypted_instances': 'ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ì¸ìŠ¤í„´ìŠ¤',
                        'unencrypted_volumes': 'ì•”í˜¸í™”ë˜ì§€ ì•Šì€ ë³¼ë¥¨',
                        'unencrypted_clusters': 'ì•”í˜¸í™”ë˜ì§€ ì•Šì€ í´ëŸ¬ìŠ¤í„°',
                        'unprotected_resources': 'ë³´í˜¸ë˜ì§€ ì•Šì€ ë¦¬ì†ŒìŠ¤',
                        'policy_violations': 'ì •ì±… ìœ„ë°˜ í•­ëª©',
                        'security_groups': 'ë³´ì•ˆ ê·¸ë£¹',
                        'access_keys': 'ì•¡ì„¸ìŠ¤ í‚¤',
                        'certificates': 'ì¸ì¦ì„œ',
                        'trails': 'í´ë¼ìš°ë“œíŠ¸ë ˆì¼',
                        'log_groups': 'ë¡œê·¸ ê·¸ë£¹',
                        'backup_vaults': 'ë°±ì—… ë³¼íŠ¸',
                        'findings': 'ë°œê²¬ëœ í•­ëª©',
                        'count': 'ê°œìˆ˜',
                        'description': 'ì„¤ëª…'
                    };
                    return keyMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                }

                // í•­ëª© ë¦¬ìŠ¤íŠ¸ í† ê¸€
                function toggleItemsList(button) {
                    const container = button.nextElementSibling;
                    const isCollapsed = container.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        container.classList.remove('collapsed');
                        button.innerHTML = 'ì ‘ê¸° â–²';
                    } else {
                        container.classList.add('collapsed');
                        button.innerHTML = 'ìƒì„¸ë³´ê¸° â–¼';
                    }
                }

                // ê³„ì • ì„ íƒ
                function selectAccount(accountId) {
                    selectedAccountId = accountId;
                    
                    // ë ˆì´ì•„ì›ƒì„ 2ì—´ë¡œ ë¦¬ì…‹
                    localStorage.setItem('diagnosisLayout', '2');

                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì„œë²„ì—ì„œ ë°ì´í„° ë°›ì•„ì˜¤ê¸°
                    window.location.href = `/diagnosis?account=${accountId}`;
                }

                // ì—°ê²° í…ŒìŠ¤íŠ¸
                async function testConnection() {
                    if (!selectedAccountId) {
                        alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    try {
                        const response = await fetch('/diagnosis/api/test-session', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            alert(`âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì„±ê³µ!\nê³„ì • ID: ${result.account_id}\nì ‘ê·¼ ê°€ëŠ¥ ë¦¬ì „: ${result.regions}ê°œ`);
                        } else {
                            alert(`âŒ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n${result.error_message}`);
                        }
                    } catch (error) {
                        alert(`ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    }
                }

                // ê°œë³„ ì§„ë‹¨ ì‹¤í–‰
                async function runSingleDiagnosis(itemCode) {
                    if (!selectedAccountId) {
                        alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    const statusElement = document.getElementById(`status-${itemCode}`);
                    const resultElement = document.getElementById(`result-${itemCode}`);

                    // ì§„í–‰ ìƒíƒœë¡œ ë³€ê²½
                    statusElement.innerHTML = '<span class="status-badge status-running">ì§„í–‰ì¤‘</span>';
                    resultElement.style.display = 'none';

                    try {
                        const response = await fetch('/diagnosis/api/run', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId,
                                item_code: itemCode
                            })
                        });

                        // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            const text = await response.text();
                            console.error('JSONì´ ì•„ë‹Œ ì‘ë‹µ:', text);
                            throw new Error(`ì„œë²„ì—ì„œ HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. Flask ì„œë²„ê°€ ì˜¬ë°”ë¥´ê²Œ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);
                        }

                        const result = await response.json();

                        if (result.status === 'success') {
                            statusElement.innerHTML = '<span class="status-badge status-completed">ì™„ë£Œ</span>';
                            displayDiagnosisResult(itemCode, result);
                        } else {
                            statusElement.innerHTML = '<span class="status-badge status-failed">ì‹¤íŒ¨</span>';
                            resultElement.innerHTML = `<div class="error-message">âŒ ${result.message}</div>`;
                            resultElement.style.display = 'block';
                        }
                    } catch (error) {
                        statusElement.innerHTML = '<span class="status-badge status-failed">ì‹¤íŒ¨</span>';
                        resultElement.innerHTML = `<div class="error-message">âŒ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</div>`;
                        resultElement.style.display = 'block';
                    }
                }

                // ì„œë²„ ìƒíƒœ ì²´í¬
                async function checkServerStatus() {
                    try {
                        const response = await fetch('/diagnosis/api/test-session', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: 'test'
                            })
                        });
                        return response.headers.get('content-type')?.includes('application/json');
                    } catch (error) {
                        return false;
                    }
                }

                // ì „ì²´ ì§„ë‹¨ ì‹¤í–‰ (ê°œë³„ ìˆœì°¨ ì‹¤í–‰ìœ¼ë¡œ ë³€ê²½)
                async function runAllDiagnosis() {
                    if (!selectedAccountId) {
                        alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    if (diagnosisInProgress) {
                        alert('ì´ë¯¸ ì§„ë‹¨ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.');
                        return;
                    }

                    // ì„œë²„ ìƒíƒœ ì²´í¬
                    const serverOk = await checkServerStatus();
                    if (!serverOk) {
                        alert('âš ï¸ Flask ì„œë²„ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ API ì—”ë“œí¬ì¸íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\në‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:\n1. Flask ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸\n2. python run.py ëª…ë ¹ìœ¼ë¡œ ì„œë²„ ì‹œì‘\n3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸');
                        return;
                    }

                    diagnosisInProgress = true;
                    
                    // ë ˆì´ì•„ì›ƒ ë¼ë””ì˜¤ ë²„íŠ¼ ë¹„í™œì„±í™”
                    setLayoutRadioEnabled(false);

                    // ì§„í–‰ ìƒíƒœ íŒ¨ë„ í‘œì‹œ
                    showProgressPanel();
                    
                    // ì§„ë‹¨ ê²°ê³¼ ì´ˆê¸°í™”
                    resetDiagnosisResults();
                    
                    // ì§„ë‹¨ ê²°ê³¼ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                    document.getElementById('resultsDashboard').style.display = 'block';

                    // ëª¨ë“  ì§„ë‹¨ í•­ëª©ì„ ëŒ€ê¸° ìƒíƒœë¡œ ë³€ê²½
                    const allItems = document.querySelectorAll('.diagnosis-item');
                    const itemCodes = Array.from(allItems).map(item => item.dataset.itemCode);

                    // ì§„ë‹¨ í•­ëª©ë“¤ì„ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
                    itemCodes.forEach(itemCode => {
                        setItemStatus(itemCode, 'waiting');
                    });

                    let completedCount = 0;
                    let failedCount = 0;
                    const totalItems = itemCodes.length;

                    addDebugLog(`ì „ì²´ ì§„ë‹¨ ì‹œì‘ - ì´ ${totalItems}ê°œ í•­ëª©`);
                    updateCurrentStatus('ì „ì²´ ì§„ë‹¨ ì‹œì‘ ì¤‘...');

                    try {
                        // ê° í•­ëª©ì„ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰
                        for (let i = 0; i < itemCodes.length; i++) {
                            const itemCode = itemCodes[i];
                            const itemName = getItemNameByCode(itemCode);

                            // í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í•­ëª© í‘œì‹œ
                            setItemStatus(itemCode, 'running');
                            updateCurrentStatus(`[${i + 1}/${totalItems}] ${itemCode} ${itemName} ì§„ë‹¨ ì¤‘...`);
                            addDebugLog(`ğŸ“‹ [${itemCode}] ${itemName} ì§„ë‹¨ ì‹œì‘`);

                            // í˜„ì¬ ì§„ë‹¨ ì¤‘ì¸ í•­ëª©ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
                            scrollToCurrentItem(itemCode);

                            try {
                                const result = await runSingleDiagnosisQuiet(itemCode);
                                setItemStatus(itemCode, 'completed');
                                completedCount++;
                                
                                // ì§„ë‹¨ ê²°ê³¼ ì—…ë°ì´íŠ¸
                                updateDiagnosisResults(result);
                                
                                addDebugLog(`âœ… [${itemCode}] ì§„ë‹¨ ì™„ë£Œ`);
                            } catch (error) {
                                setItemStatus(itemCode, 'completed'); // ì‹¤íŒ¨í•´ë„ ë²„íŠ¼ì€ ë³µêµ¬
                                failedCount++;
                                addDebugLog(`âŒ [${itemCode}] ì§„ë‹¨ ì‹¤íŒ¨: ${error.message}`);
                            }

                            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                            const progressPercentage = Math.round(((i + 1) / totalItems) * 100);
                            updateProgressStats(progressPercentage, completedCount, failedCount);

                            // ì§„ë‹¨ ê°„ ì ì‹œ ëŒ€ê¸° (UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´)
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }

                        // ì™„ë£Œ ì²˜ë¦¬
                        updateCurrentStatus(`ì „ì²´ ì§„ë‹¨ ì™„ë£Œ! ì„±ê³µ: ${completedCount}ê°œ, ì‹¤íŒ¨: ${failedCount}ê°œ`);
                        addDebugLog(`ğŸ‰ ì „ì²´ ì§„ë‹¨ ì™„ë£Œ - ì„±ê³µ: ${completedCount}ê°œ, ì‹¤íŒ¨: ${failedCount}ê°œ`);

                        // ì§„ë‹¨ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½ (íŒ¨ë„ì€ ìˆ¨ê¸°ì§€ ì•ŠìŒ)
                        markDiagnosisCompleted(completedCount, failedCount, totalItems);

                        // ì „ì²´ ì§„ë‹¨ ì™„ë£Œ í›„ ë§¨ ìœ„ë¡œ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
                        setTimeout(() => {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        }, 1000);

                    } catch (error) {
                        addDebugLog(`âŒ ì „ì²´ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                        updateCurrentStatus(`ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                    } finally {
                        diagnosisInProgress = false;
                        // ë ˆì´ì•„ì›ƒ ë¼ë””ì˜¤ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                        setLayoutRadioEnabled(true);
                    }
                }

                // ì§„ë‹¨ ê²°ê³¼ í‘œì‹œ
                function displayDiagnosisResult(itemCode, result) {
                    const resultElement = document.getElementById(`result-${itemCode}`);
                    const diagnosisResult = result.result;

                    let resultHTML = '<div class="result-summary">';

                    if (diagnosisResult.status === 'success') {
                        resultHTML += `<div class="result-item">
                            <strong>ìœ„í—˜ë„:</strong> <span class="risk-level risk-${diagnosisResult.risk_level}">${diagnosisResult.risk_level}</span>
                        </div>`;

                        if (diagnosisResult.has_issues) {
                            resultHTML += '<div class="result-item"><strong>âš ï¸ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤</strong></div>';
                        } else {
                            resultHTML += '<div class="result-item"><strong>âœ… ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</strong></div>';
                        }

                        // ìš”ì•½ ì •ë³´ í‘œì‹œ
                        if (diagnosisResult.summary) {
                            resultHTML += `<div class="result-item"><strong>summary:</strong> ${diagnosisResult.summary}</div>`;
                        }

                        // ìƒì„¸ ì •ë³´ê°€ ìˆìœ¼ë©´ í–‰ í˜•íƒœë¡œ í‘œì‹œ
                        if (diagnosisResult.details && typeof diagnosisResult.details === 'object') {
                            resultHTML += '<div class="result-details">';
                            resultHTML += '<div class="details-rows">';
                            
                            // ë¹ˆ ê°’ í•„í„°ë§ í•¨ìˆ˜
                            function hasValidContent(value) {
                                if (value === null || value === undefined || value === '') return false;
                                if (typeof value === 'object' && Object.keys(value).length === 0) return false;
                                if (Array.isArray(value) && value.length === 0) return false;
                                if (typeof value === 'object' && value.count === 0) return false;
                                return true;
                            }
                            
                            Object.entries(diagnosisResult.details).forEach(([key, value]) => {
                                // ë¹ˆ ê°’ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                                if (!hasValidContent(value)) return;
                                
                                // í–‰ ì‹œì‘
                                resultHTML += '<div class="detail-row">';
                                
                                // í‚¤ë¥¼ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ë³€í™˜
                                const friendlyKey = convertKeyToFriendlyName(key);
                                resultHTML += `<div class="row-label">${friendlyKey}</div>`;
                                
                                // ê°’ì„ ì ì ˆíˆ í¬ë§·íŒ…
                                resultHTML += '<div class="row-content">';
                                
                                if (typeof value === 'object' && value !== null) {
                                    // ì¹´ìš´íŠ¸ê°€ ìˆëŠ” ê²½ìš°
                                    if (value.count !== undefined) {
                                        resultHTML += `<span class="count-badge">${value.count}ê±´</span>`;
                                    }
                                    
                                    // ìš”ì•½ ì •ë³´
                                    if (value.summary) {
                                        resultHTML += `<div class="summary-text">${value.summary}</div>`;
                                    }
                                    
                                    // ì„¤ëª…
                                    if (value.description) {
                                        resultHTML += `<div class="description-text">${value.description}</div>`;
                                    }
                                    
                                    // ì‚¬ìš©ì ë¦¬ìŠ¤íŠ¸
                                    if (value.users && Array.isArray(value.users)) {
                                        resultHTML += '<div class="users-container">';
                                        value.users.forEach(user => {
                                            resultHTML += `<span class="user-tag">${user}</span>`;
                                        });
                                        resultHTML += '</div>';
                                    }
                                    
                                    // ë°°ì—´ ë°ì´í„° ì²˜ë¦¬ (ì •ì±…, ê·œì¹™ ë“±)
                                    if (Array.isArray(value) && value.length > 0) {
                                        if (value.length <= 3) {
                                            // 3ê°œ ì´í•˜ë©´ ëª¨ë‘ í‘œì‹œ
                                            resultHTML += '<div class="items-container">';
                                            value.forEach(item => {
                                                if (typeof item === 'string') {
                                                    resultHTML += `<div class="item-simple">${item}</div>`;
                                                } else if (typeof item === 'object' && item.description) {
                                                    resultHTML += `<div class="item-description">${item.description}</div>`;
                                                }
                                            });
                                            resultHTML += '</div>';
                                        } else {
                                            // 3ê°œ ì´ˆê³¼ë©´ ìš”ì•½ + í† ê¸€
                                            resultHTML += `<div class="items-summary">${value.length}ê°œ í•­ëª© ë°œê²¬</div>`;
                                            resultHTML += `<button class="toggle-items-btn" onclick="toggleItemsList(this)">ìƒì„¸ë³´ê¸° â–¼</button>`;
                                            resultHTML += '<div class="items-container collapsed">';
                                            value.forEach(item => {
                                                if (typeof item === 'string') {
                                                    resultHTML += `<div class="item-simple">${item}</div>`;
                                                } else if (typeof item === 'object' && item.description) {
                                                    resultHTML += `<div class="item-description">${item.description}</div>`;
                                                }
                                            });
                                            resultHTML += '</div>';
                                        }
                                    }
                                } else {
                                    // ë‹¨ìˆœ ê°’
                                    resultHTML += `<span class="simple-value">${value}</span>`;
                                }
                                
                                resultHTML += '</div>'; // row-content ì¢…ë£Œ
                                resultHTML += '</div>'; // detail-row ì¢…ë£Œ
                            });
                            
                            resultHTML += '</div>'; // details-rows ì¢…ë£Œ
                            resultHTML += '</div>'; // result-details ì¢…ë£Œ
                        }

                        // ìë™ ì¡°ì¹˜ ì˜µì…˜ í‘œì‹œ
                        if (diagnosisResult.fix_options && Array.isArray(diagnosisResult.fix_options)) {
                            resultHTML += '<div class="fix-options">';
                            resultHTML += '<strong>ìë™ ì¡°ì¹˜ ì˜µì…˜:</strong>';
                            diagnosisResult.fix_options.forEach((option, index) => {
                                resultHTML += `
                                    <div class="fix-option">
                                        <div class="fix-option-header">
                                            <h4>${option.title}</h4>
                                            <p>${option.description}</p>
                                        </div>
                                        <div class="fix-option-items">
                                            ${option.items.map(item => `
                                                <label class="fix-item">
                                                    <input type="checkbox" value="${item.id}" data-option-id="${option.id}" checked>
                                                    <span>${item.name} - ${item.description}</span>
                                                </label>
                                            `).join('')}
                                        </div>
                                        <button class="btn btn-warning btn-fix" onclick="executeFix('${itemCode}', '${option.id}', this)">
                                            <span>âš¡</span> ${option.title} ì‹¤í–‰
                                        </button>
                                    </div>
                                `;
                            });
                            resultHTML += '</div>';
                        }

                        // ìˆ˜ë™ ì¡°ì¹˜ ê°€ì´ë“œ í‘œì‹œ
                        if (diagnosisResult.manual_guide) {
                            const guide = diagnosisResult.manual_guide;
                            const toggleId = `manual-guide-${itemCode.replace('.', '-')}`;
                            
                            resultHTML += '<div class="manual-guide-box">';
                            resultHTML += `<div class="manual-guide-header" onclick="toggleManualGuide('${toggleId}')">
                                <div class="manual-guide-title-section">
                                    <h4>ğŸ“‹ ${guide.title}</h4>
                                    <p class="manual-guide-description">${guide.description}</p>
                                </div>
                                <button class="manual-guide-toggle-btn" id="toggle-btn-${toggleId}">
                                    <span class="toggle-icon">â–¼</span>
                                </button>
                            </div>`;

                            resultHTML += `<div class="manual-guide-content" id="${toggleId}" style="display: none;">`;
                            if (guide.steps && Array.isArray(guide.steps)) {
                                resultHTML += '<div class="manual-guide-steps">';
                                guide.steps.forEach((step, index) => {
                                    let stepClass = 'manual-step';
                                    if (step.type === 'warning') stepClass += ' step-warning';
                                    else if (step.type === 'danger') stepClass += ' step-danger';
                                    else if (step.type === 'info') stepClass += ' step-info';
                                    else if (step.type === 'step') stepClass += ' step-action';
                                    else if (step.type === 'commands') stepClass += ' step-commands';

                                    resultHTML += `<div class="${stepClass}">`;
                                    resultHTML += `<div class="step-title">${step.title}</div>`;

                                    if (step.type === 'commands' && Array.isArray(step.content)) {
                                        resultHTML += '<div class="step-content commands-content">';
                                        
                                        // ì „ì²´ ì½”ë“œ ë¸”ë¡ì„ í•˜ë‚˜ë¡œ ë¬¶ê¸°
                                        let fullCodeBlock = '';
                                        let hasValidCommands = false;
                                        
                                        step.content.forEach(command => {
                                            // ë¹ˆ ë¬¸ìì—´ì´ê±°ë‚˜ ê³µë°±ë§Œ ìˆëŠ” ê²½ìš° ì¤„ë°”ê¿ˆ ì¶”ê°€
                                            if (!command || command.trim() === '') {
                                                fullCodeBlock += '\n';
                                            } else {
                                                fullCodeBlock += command + '\n';
                                                hasValidCommands = true;
                                            }
                                        });
                                        
                                        // ìœ íš¨í•œ ëª…ë ¹ì–´ê°€ ìˆì„ ë•Œë§Œ ì½”ë“œ ë¸”ë¡ ìƒì„±
                                        if (hasValidCommands) {
                                            // ë§ˆì§€ë§‰ ì¤„ë°”ê¿ˆ ì œê±°
                                            fullCodeBlock = fullCodeBlock.trim();
                                            
                                            // HTMLê³¼ JavaScriptì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                                            const escapedCode = fullCodeBlock.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                                            const safeCode = fullCodeBlock.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
                                            
                                            resultHTML += `<div class="unified-code-block">
                                                <pre class="code-content"><code>${escapedCode}</code></pre>
                                                <button class="btn btn-copy-all" onclick="copyToClipboard('${safeCode}')">
                                                    ğŸ“‹ ì „ì²´ ë³µì‚¬
                                                </button>
                                            </div>`;
                                        }
                                        
                                        resultHTML += '</div>';
                                    } else {
                                        resultHTML += `<div class="step-content">${step.content}</div>`;
                                    }
                                    resultHTML += '</div>';
                                });
                                resultHTML += '</div>';
                            }
                            resultHTML += '</div>'; // manual-guide-content ë‹«ê¸°
                            resultHTML += '</div>'; // manual-guide-box ë‹«ê¸°
                        }
                    } else {
                        resultHTML += `<div class="error-message">âŒ ${diagnosisResult.error_message}</div>`;
                    }

                    resultHTML += '</div>';

                    resultElement.innerHTML = resultHTML;
                    resultElement.style.display = 'block';
                }


                // ìë™ ì¡°ì¹˜ ì‹¤í–‰
                async function executeFix(itemCode, optionId, buttonElement) {
                    if (!selectedAccountId) {
                        alert('ê³„ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    // ì„ íƒëœ í•­ëª©ë“¤ ìˆ˜ì§‘
                    const checkboxes = document.querySelectorAll(`input[data-option-id="${optionId}"]:checked`);
                    if (checkboxes.length === 0) {
                        alert('ì¡°ì¹˜í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    const selectedItems = {};
                    selectedItems[optionId] = Array.from(checkboxes).map(cb => ({
                        id: cb.value,
                        name: cb.value,
                        description: cb.parentElement.textContent.trim()
                    }));

                    // í™•ì¸ ë©”ì‹œì§€
                    const itemCount = checkboxes.length;
                    const confirmMessage = `ì •ë§ë¡œ ${itemCount}ê°œ í•­ëª©ì— ëŒ€í•´ ìë™ ì¡°ì¹˜ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;

                    if (!confirm(confirmMessage)) {
                        return;
                    }

                    // ë²„íŠ¼ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì°¾ê¸°
                    let executeButton = buttonElement;
                    if (!executeButton) {
                        executeButton = document.querySelector(`button[onclick*="executeFix('${itemCode}', '${optionId}')"]`);
                    }

                    // ë²„íŠ¼ ìƒíƒœ ì €ì¥
                    let originalText = '';
                    if (executeButton) {
                        originalText = executeButton.innerHTML;
                        executeButton.disabled = true;
                        executeButton.innerHTML = '<span>â³</span> ì‹¤í–‰ ì¤‘...';
                    }

                    try {
                        const response = await fetch('/diagnosis/api/fix', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                account_id: selectedAccountId,
                                item_code: itemCode,
                                selected_items: selectedItems
                            })
                        });

                        const result = await response.json();

                        if (result.status === 'success') {
                            let successCount = 0;
                            let failCount = 0;
                            let message = 'ìë™ ì¡°ì¹˜ ì‹¤í–‰ ê²°ê³¼:\n\n';

                            result.results.forEach(res => {
                                if (res.status === 'success') {
                                    successCount++;
                                    message += `âœ… ${res.message}\n`;
                                } else {
                                    failCount++;
                                    message += `âŒ ${res.message}\n`;
                                }
                            });

                            message += `\nì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${failCount}ê°œ`;
                            alert(message);

                            // ì„±ê³µí–ˆìœ¼ë©´ í•´ë‹¹ í•­ëª© ì¬ì§„ë‹¨
                            if (successCount > 0) {
                                setTimeout(() => {
                                    runSingleDiagnosis(itemCode);
                                }, 1000);
                            }
                        } else {
                            alert(`âŒ ìë™ ì¡°ì¹˜ ì‹¤íŒ¨\n${result.message}`);
                        }

                    } catch (error) {
                        alert(`ìë™ ì¡°ì¹˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    } finally {
                        // ë²„íŠ¼ ë³µêµ¬
                        if (executeButton && originalText) {
                            executeButton.disabled = false;
                            executeButton.innerHTML = originalText;
                        }
                    }
                }

                // ì¬ì§„ë‹¨
                function rediagnose(button) {
                    const itemElement = button.closest('.diagnosis-item');
                    const itemCode = itemElement.dataset.itemCode;
                    runSingleDiagnosis(itemCode);
                }

                // ì§„í–‰ ìƒíƒœ ì‚¬ì´ë“œë°” í‘œì‹œ/ìˆ¨ê¸°ê¸°
                function showProgressPanel() {
                    document.getElementById('progressSidebar').style.display = 'block';
                    resetProgressStats();
                }

                function hideProgressPanel() {
                    document.getElementById('progressSidebar').style.display = 'none';
                }

                // ì§„ë‹¨ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
                function markDiagnosisCompleted(completedCount, failedCount, totalItems) {
                    // ì‚¬ì´ë“œë°” ì œëª©ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
                    const sidebarTitle = document.querySelector('#progressSidebar h4');
                    if (sidebarTitle) {
                        sidebarTitle.innerHTML = `
                            <span class="text-lg mr-2">âœ…</span>
                            ì§„ë‹¨ ì™„ë£Œ
                        `;
                    }

                    // ì™„ë£Œ ìš”ì•½ ì •ë³´ ì¶”ê°€
                    const completionRate = Math.round((completedCount / totalItems) * 100);
                    addDebugLog(`ğŸ“Š ì™„ë£Œìœ¨: ${completionRate}% (${completedCount}/${totalItems})`);

                    // í˜„ì¬ ìƒíƒœë¥¼ ì™„ë£Œ ìƒíƒœë¡œ ê³ ì •
                    updateCurrentStatus(`ì§„ë‹¨ ì™„ë£Œ - ì„±ê³µë¥ : ${completionRate}%`);

                    // ì‚¬ì´ë“œë°” ë°°ê²½ìƒ‰ì„ ì™„ë£Œ ìƒíƒœë¡œ ë³€ê²½
                    const progressSidebar = document.getElementById('progressSidebar');
                    if (progressSidebar) {
                        progressSidebar.style.borderLeft = '4px solid #10b981';
                        progressSidebar.style.backgroundColor = '#f0fdf4';
                    }
                }

                // ì§„í–‰ ìƒíƒœ ì´ˆê¸°í™”
                function resetProgressStats() {
                    updateProgressStats(0, 0, 0);
                    updateCurrentStatus('ì§„ë‹¨ ì¤€ë¹„ ì¤‘...');
                    clearDebugLog();
                    addDebugLog('ì§„ë‹¨ ì‹œì‘ ì¤€ë¹„ ì¤‘...');

                    // ì‚¬ì´ë“œë°” ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
                    const sidebarTitle = document.querySelector('#progressSidebar h4');
                    if (sidebarTitle) {
                        sidebarTitle.innerHTML = `
                            <span class="text-lg mr-2">ğŸš€</span>
                            ì§„ë‹¨ ì§„í–‰ ìƒí™©
                        `;
                    }

                    // ì‚¬ì´ë“œë°” ë°°ê²½ìƒ‰ ì´ˆê¸°í™”
                    const progressSidebar = document.getElementById('progressSidebar');
                    if (progressSidebar) {
                        progressSidebar.style.borderLeft = '';
                        progressSidebar.style.backgroundColor = '';
                    }
                }

                // ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
                function updateProgressStats(percentage, completed, failed) {
                    document.getElementById('progressPercentageValue').textContent = `${percentage}%`;
                    document.getElementById('completedCountValue').textContent = completed;
                    document.getElementById('failedCountValue').textContent = failed;
                    document.getElementById('progressFillBar').style.width = `${percentage}%`;
                }

                // í˜„ì¬ ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                function updateCurrentStatus(message) {
                    document.getElementById('currentStatusText').textContent = message;
                }

                // ë¡œê·¸ ê¸°ëŠ¥ ì œê±°ë¨ - ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€ (ê¸°ì¡´ í˜¸ì¶œ ì½”ë“œ í˜¸í™˜ì„±)
                function addDebugLog(message) {
                    // ë¡œê·¸ ê¸°ëŠ¥ ì œê±°ë¨
                }

                // ë¡œê·¸ ê¸°ëŠ¥ ì œê±°ë¨ - ë¹ˆ í•¨ìˆ˜ë¡œ ìœ ì§€ (ê¸°ì¡´ í˜¸ì¶œ ì½”ë“œ í˜¸í™˜ì„±)
                function clearDebugLog() {
                    // ë¡œê·¸ ê¸°ëŠ¥ ì œê±°ë¨
                }

                // í•­ëª© ìƒíƒœ ì„¤ì •
                function setItemStatus(itemCode, status) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (!itemElement) {
                        console.warn(`í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${itemCode}`);
                        return;
                    }

                    const actionButton = itemElement.querySelector('.item-actions .btn:not(.btn-disabled)');
                    if (!actionButton) {
                        console.warn(`ì§„ë‹¨ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${itemCode}`);
                        return;
                    }

                    const resultElement = document.getElementById(`result-${itemCode}`);

                    if (status === 'waiting') {
                        actionButton.innerHTML = '<span>â³</span> ëŒ€ê¸° ì¤‘';
                        actionButton.disabled = true;
                        if (resultElement) {
                            resultElement.style.display = 'none';
                        }
                    } else if (status === 'running') {
                        actionButton.innerHTML = '<span>ğŸ”„</span> ì‹¤í–‰ ì¤‘';
                        actionButton.disabled = true;
                    } else if (status === 'completed') {
                        actionButton.innerHTML = '<span>ğŸ¯</span> ì§„ë‹¨ ì‹¤í–‰';
                        actionButton.disabled = false;
                    }
                }

                // í•­ëª© ì½”ë“œë¡œ ì´ë¦„ ì¡°íšŒ
                function getItemNameByCode(itemCode) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (!itemElement) return itemCode;

                    const titleElement = itemElement.querySelector('.item-name');
                    return titleElement ? titleElement.textContent.trim() : itemCode;
                }

                // í˜„ì¬ ì§„ë‹¨ ì¤‘ì¸ í•­ëª©ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
                function scrollToCurrentItem(itemCode) {
                    const itemElement = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (itemElement) {
                        // ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤í•˜ë©´ì„œ í•­ëª©ì„ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜
                        itemElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });

                        // í˜„ì¬ ì§„ë‹¨ ì¤‘ì¸ í•­ëª© ê°•ì¡° íš¨ê³¼
                        highlightCurrentItem(itemCode);
                    }
                }

                // í˜„ì¬ ì§„ë‹¨ ì¤‘ì¸ í•­ëª© ê°•ì¡° íš¨ê³¼
                function highlightCurrentItem(itemCode) {
                    // ê¸°ì¡´ ê°•ì¡° íš¨ê³¼ ì œê±°
                    document.querySelectorAll('.diagnosis-item').forEach(item => {
                        item.classList.remove('current-diagnosing');
                    });

                    // í˜„ì¬ í•­ëª©ì— ê°•ì¡° íš¨ê³¼ ì¶”ê°€
                    const currentItem = document.querySelector(`[data-item-code="${itemCode}"]`);
                    if (currentItem) {
                        currentItem.classList.add('current-diagnosing');

                        // 3ì´ˆ í›„ ê°•ì¡° íš¨ê³¼ ì œê±° (ì§„ë‹¨ì´ ì™„ë£Œë˜ë©´)
                        setTimeout(() => {
                            currentItem.classList.remove('current-diagnosing');
                        }, 3000);
                    }
                }

                // ì¡°ìš©í•œ ë‹¨ì¼ ì§„ë‹¨ (ë¡œê·¸ ì—†ì´)
                async function runSingleDiagnosisQuiet(itemCode) {
                    const response = await fetch('/diagnosis/api/run', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            account_id: selectedAccountId,
                            item_code: itemCode
                        })
                    });

                    // ì‘ë‹µì´ JSONì¸ì§€ í™•ì¸
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('JSONì´ ì•„ë‹Œ ì‘ë‹µ:', text);
                        throw new Error(`ì„œë²„ì—ì„œ HTMLì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. Flask ì„œë²„ê°€ ì˜¬ë°”ë¥´ê²Œ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);
                    }

                    const result = await response.json();

                    if (result.status === 'success') {
                        displayDiagnosisResult(itemCode, result);
                        return result;  // ê²°ê³¼ ë°˜í™˜ ì¶”ê°€
                    } else {
                        throw new Error(result.message || 'ì§„ë‹¨ ì‹¤íŒ¨');
                    }
                }

                // ì§„ë‹¨ ê²°ê³¼ ì´ˆê¸°í™”
                function resetDiagnosisResults() {
                    diagnosisResults = {
                        total: 0,
                        vulnerable: 0,
                        safe: 0,
                        highRisk: 0,
                        mediumRisk: 0,
                        lowRisk: 0
                    };
                    updateDashboard();
                }

                // ì§„ë‹¨ ê²°ê³¼ ì—…ë°ì´íŠ¸
                function updateDiagnosisResults(result) {
                    if (!result || !result.result) return;
                    
                    console.log('ì§„ë‹¨ ê²°ê³¼ ì—…ë°ì´íŠ¸:', result);
                    
                    diagnosisResults.total++;
                    
                    // ì·¨ì•½/ì•ˆì „ íŒë‹¨
                    if (result.result.has_issues) {
                        diagnosisResults.vulnerable++;
                    } else {
                        diagnosisResults.safe++;
                    }
                    
                    // ìœ„í—˜ë„ë³„ ë¶„ë¥˜
                    const riskLevel = result.result.risk_level;
                    console.log('ìœ„í—˜ë„ ë ˆë²¨:', riskLevel);
                    
                    if (riskLevel === 'high') {
                        diagnosisResults.highRisk++;
                    } else if (riskLevel === 'medium') {
                        diagnosisResults.mediumRisk++;
                    } else if (riskLevel === 'low') {
                        diagnosisResults.lowRisk++;
                    } else {
                        console.warn('ì•Œ ìˆ˜ ì—†ëŠ” ìœ„í—˜ë„ ë ˆë²¨:', riskLevel);
                    }
                    
                    console.log('í˜„ì¬ ì§„ë‹¨ ê²°ê³¼ ìƒíƒœ:', diagnosisResults);
                    updateDashboard();
                }

                // ëŒ€ì‹œë³´ë“œ UI ì—…ë°ì´íŠ¸
                function updateDashboard() {
                    // ì´ ì§„ë‹¨ í•­ëª©
                    document.getElementById('totalScanned').textContent = diagnosisResults.total;
                    
                    // ì·¨ì•½ í•­ëª©
                    document.getElementById('vulnerableCount').textContent = diagnosisResults.vulnerable;
                    const vulnerablePercentage = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.vulnerable / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('vulnerablePercentage').textContent = `${vulnerablePercentage}%`;
                    
                    // ì•ˆì „ í•­ëª©
                    document.getElementById('safeCount').textContent = diagnosisResults.safe;
                    const safePercentage = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.safe / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('safePercentage').textContent = `${safePercentage}%`;
                    
                    // ìœ„í—˜ë„ë³„ ë¶„í¬
                    document.getElementById('highRiskCount').textContent = diagnosisResults.highRisk;
                    document.getElementById('mediumRiskCount').textContent = diagnosisResults.mediumRisk;
                    document.getElementById('lowRiskCount').textContent = diagnosisResults.lowRisk;
                    
                    // ì•ˆì „ë¥  ë°”
                    const safetyRate = diagnosisResults.total > 0 
                        ? Math.round((diagnosisResults.safe / diagnosisResults.total) * 100) 
                        : 0;
                    document.getElementById('safetyRate').textContent = `${safetyRate}%`;
                    document.getElementById('safetyBarFill').style.width = `${safetyRate}%`;
                }

                // í´ë¦½ë³´ë“œ ë³µì‚¬
                async function copyToClipboard(text) {
                    try {
                        await navigator.clipboard.writeText(text);
                        // ì„ì‹œ ì•Œë¦¼ í‘œì‹œ (ì„ íƒì‚¬í•­)
                        const button = event.target;
                        const originalText = button.textContent;
                        button.textContent = 'âœ…';
                        setTimeout(() => {
                            button.textContent = originalText;
                        }, 1000);
                    } catch (err) {
                        // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            const button = event.target;
                            const originalText = button.textContent;
                            button.textContent = 'âœ…';
                            setTimeout(() => {
                                button.textContent = originalText;
                            }, 1000);
                        } catch (err) {
                            alert('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                        document.body.removeChild(textArea);
                    }
                }

                // ë ˆì´ì•„ì›ƒ ë³€ê²½ í•¨ìˆ˜
                function changeLayout(columns) {
                    const itemsGrid = document.querySelectorAll('.items-grid');
                    
                    itemsGrid.forEach(grid => {
                        if (columns === 1) {
                            grid.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
                            grid.classList.add('space-y-4');
                        } else {
                            grid.classList.remove('space-y-4');
                            grid.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2', 'gap-4');
                        }
                    });
                    
                    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    localStorage.setItem('diagnosisLayout', columns.toString());
                }

                // ë¼ë””ì˜¤ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
                function setLayoutRadioEnabled(enabled) {
                    const radios = document.querySelectorAll('input[name="layout"]');
                    const labels = document.querySelectorAll('#layoutRadioGroup label');
                    
                    radios.forEach(radio => {
                        radio.disabled = !enabled;
                    });
                    
                    labels.forEach(label => {
                        if (enabled) {
                            label.classList.remove('opacity-50', 'cursor-not-allowed');
                            label.classList.add('cursor-pointer');
                        } else {
                            label.classList.add('opacity-50', 'cursor-not-allowed');
                            label.classList.remove('cursor-pointer');
                        }
                    });
                }

                // í˜ì´ì§€ ë¡œë“œ ì‹œ ì„ íƒëœ ê³„ì •ì´ ìˆìœ¼ë©´ ìë™ ì„ íƒ
                document.addEventListener('DOMContentLoaded', function() {
                    {% if selected_account %}
                    selectedAccountId = '{{ selected_account.account_id }}';

                    // ì œì–´íŒê³¼ ì§„ë‹¨ í•­ëª©ì´ ì¡´ì¬í•˜ë©´ í‘œì‹œ
                    const controlPanel = document.getElementById('controlPanel');
                    const diagnosisItems = document.getElementById('diagnosisItems');

                    if (controlPanel) {
                        controlPanel.style.display = 'block';
                    }
                    if (diagnosisItems) {
                        diagnosisItems.style.display = 'block';
                    }
                    {% endif %}
                    
                    // ì €ì¥ëœ ë ˆì´ì•„ì›ƒ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedLayout = localStorage.getItem('diagnosisLayout');
                    if (savedLayout) {
                        const radio = document.getElementById(savedLayout === '1' ? 'layout1Col' : 'layout2Col');
                        if (radio) {
                            radio.checked = true;
                            changeLayout(parseInt(savedLayout));
                        }
                    }
                    
                    // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                    const layoutRadios = document.querySelectorAll('input[name="layout"]');
                    layoutRadios.forEach(radio => {
                        radio.addEventListener('change', function() {
                            changeLayout(parseInt(this.value));
                        });
                    });
                });

                // ìˆ˜ë™ ì¡°ì¹˜ ê°€ì´ë“œ í† ê¸€ í•¨ìˆ˜
                function toggleManualGuide(toggleId) {
                    const content = document.getElementById(toggleId);
                    const toggleBtn = document.getElementById(`toggle-btn-${toggleId}`);
                    const toggleIcon = toggleBtn.querySelector('.toggle-icon');
                    
                    if (content.style.display === 'none' || content.style.display === '') {
                        content.style.display = 'block';
                        toggleIcon.textContent = 'â–²';
                        toggleBtn.setAttribute('aria-expanded', 'true');
                    } else {
                        content.style.display = 'none';
                        toggleIcon.textContent = 'â–¼';
                        toggleBtn.setAttribute('aria-expanded', 'false');
                    }
                }
            </script>
            {% endblock %} {% block extra_css %}
            <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/diagnosis.css') }}" />
            {% endblock %}
        </div>
    </div>
</div>
