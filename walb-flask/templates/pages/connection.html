{% extends "base.html" %}

{% block title %}WALB AWS 계정 연결{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/connection.css') }}">
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-gradient-to-r from-green-600 to-blue-600 rounded-2xl p-8 text-white mb-8 relative overflow-hidden">
    <div class="relative z-10">
        <div class="flex items-center mb-4">
            <span class="text-4xl mr-4 animate-bounce">🔗</span>
            <div>
                <h1 class="text-3xl font-bold mb-2">AWS 계정 연결</h1>
                <p class="text-green-100">WALB 보안 관리를 위한 AWS 계정을 연결합니다</p>
            </div>
        </div>
    </div>
    
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-10">
        <div class="absolute top-10 right-10 w-20 h-20 bg-white rounded-full animate-pulse"></div>
        <div class="absolute bottom-10 right-20 w-16 h-16 bg-white rounded-full animate-pulse delay-1000"></div>
        <div class="absolute top-20 left-20 w-12 h-12 bg-white rounded-full animate-pulse delay-2000"></div>
    </div>
</div>

<!-- Connection Steps -->
<div class="bg-white rounded-xl shadow-sm border p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-900 mb-6">📋 연결 단계</h2>
    
    <!-- Steps Navigation -->
    <div class="flex items-center justify-between mb-8">
        <div class="step-item active" data-step="1">
            <div class="step-circle">1</div>
            <span class="step-text">연결 방식 선택</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item" data-step="2">
            <div class="step-circle">2</div>
            <span class="step-text">권한 설정</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item" data-step="3">
            <div class="step-circle">3</div>
            <span class="step-text">계정 정보 입력</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item" data-step="4">
            <div class="step-circle">4</div>
            <span class="step-text">연결 테스트</span>
        </div>
    </div>
    
    <!-- Step 1: Connection Method -->
    <div class="step-content" id="step-1">
        <h3 class="text-lg font-semibold mb-4">🔧 연결 방식을 선택해주세요</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Cross-Account Role Method -->
            <div class="connection-method-card" data-method="role">
                <div class="p-6 border-2 border-gray-200 rounded-lg hover:border-blue-500 transition-colors cursor-pointer">
                    <div class="flex items-center mb-4">
                        <span class="text-3xl mr-4">🛡️</span>
                        <div>
                            <h4 class="font-semibold text-gray-900">Cross-Account Role</h4>
                            <span class="text-sm text-green-600 bg-green-100 px-2 py-1 rounded">권장</span>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">
                        IAM Role을 통한 안전한 임시 자격증명 방식입니다. 
                        장기 자격증명 노출 위험이 없어 가장 안전합니다.
                    </p>
                    <ul class="text-sm text-gray-500 space-y-1">
                        <li>✅ 높은 보안성</li>
                        <li>✅ 임시 자격증명</li>
                        <li>✅ 세밀한 권한 제어</li>
                        <li>⚠️ 초기 설정 필요</li>
                    </ul>
                </div>
            </div>
            
            <!-- Access Key Method -->
            <div class="connection-method-card" data-method="access_key">
                <div class="p-6 border-2 border-gray-200 rounded-lg hover:border-blue-500 transition-colors cursor-pointer">
                    <div class="flex items-center mb-4">
                        <span class="text-3xl mr-4">🔑</span>
                        <div>
                            <h4 class="font-semibold text-gray-900">Access Key</h4>
                            <span class="text-sm text-yellow-600 bg-yellow-100 px-2 py-1 rounded">주의필요</span>
                        </div>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">
                        AWS Access Key와 Secret Key를 직접 사용하는 방식입니다. 
                        빠른 설정이 가능하나 보안상 주의가 필요합니다.
                    </p>
                    <ul class="text-sm text-gray-500 space-y-1">
                        <li>✅ 빠른 설정</li>
                        <li>✅ 간단한 구성</li>
                        <li>⚠️ 장기 자격증명</li>
                        <li>⚠️ 키 관리 필요</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 2: Permission Setup -->
    <div class="step-content hidden" id="step-2">
        <h3 class="text-lg font-semibold mb-4">🔐 권한 설정 가이드</h3>
        
        <!-- Role Method Guide -->
        <div class="permission-guide" id="role-guide">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <h4 class="font-semibold text-blue-900 mb-3">Cross-Account Role 설정</h4>
                <div class="space-y-4">
                    <div>
                        <h5 class="font-medium text-blue-800 mb-2">1. IAM Role 생성</h5>
                        <p class="text-blue-700 text-sm mb-2">AWS Console에서 다음 <span class="font-bold">사용자 지정 신뢰 정책</span>으로 Role을 생성하세요:</p>
                        <div class="bg-gray-800 text-green-400 p-4 rounded text-sm font-mono overflow-x-auto">
                            <pre id="trust-policy-json">{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::292967571836:user/walb-service-user"
      },
      "Action": "sts:AssumeRole",
      "Condition": {
        "StringEquals": {
          "sts:ExternalId": "EXTERNAL_ID"
        }
      }
    }
  ]
}</pre>
                        </div>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-blue-800 mb-2">2. Permission Policy 연결</h5>
                        <p class="text-blue-700 text-sm mb-2">AdministratorAccess 정책을 연결하세요:</p>
                        <div class="bg-blue-100 border border-blue-300 rounded-lg p-4">
                            <div class="flex items-center mb-2">
                                <span class="text-blue-800 font-semibold">AWS 관리형 정책 사용:</span>
                            </div>
                            <div class="bg-gray-800 text-green-400 p-3 rounded text-sm font-mono">
                                <pre>AdministratorAccess</pre>
                            </div>
                            <p class="text-blue-700 text-xs mt-2">
                                📋 AWS Console → IAM → Roles → [생성한 Role] → Permissions → Attach policies → AdministratorAccess 검색 후 연결
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Access Key Method Guide -->
        <div class="permission-guide hidden" id="access-key-guide">
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                <h4 class="font-semibold text-yellow-900 mb-3">Access Key 설정</h4>
                <div class="space-y-4">
                    <div>
                        <h5 class="font-medium text-yellow-800 mb-2">1. IAM 사용자 생성</h5>
                        <p class="text-yellow-700 text-sm">WALB 전용 IAM 사용자를 생성하고 프로그래밍 방식 액세스를 활성화하세요.</p>
                    </div>
                    
                    <div>
                        <h5 class="font-medium text-yellow-800 mb-2">2. 권한 정책 연결</h5>
                        <p class="text-yellow-700 text-sm mb-2">AdministratorAccess 정책을 연결하세요:</p>
                        <div class="bg-yellow-100 border border-yellow-300 rounded-lg p-3">
                            <div class="bg-gray-800 text-green-400 p-2 rounded text-sm font-mono">
                                <pre>AdministratorAccess</pre>
                            </div>
                            <p class="text-yellow-700 text-xs mt-2">
                                📋 AWS Console → IAM → Users → [생성한 User] → Permissions → Attach policies → AdministratorAccess 검색 후 연결
                            </p>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded p-3">
                        <p class="text-red-700 text-sm">
                            <strong>⚠️ 보안 주의사항:</strong> Access Key는 안전한 곳에 보관하고, 정기적으로 교체하세요. 
                            가능하면 Cross-Account Role 방식을 사용하는 것을 권장합니다.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Step 3: Account Information -->
    <div class="step-content hidden" id="step-3">
        <h3 class="text-lg font-semibold mb-4">📝 계정 정보를 입력해주세요</h3>
        
        <form id="account-form" class="space-y-6">
            <!-- Basic Information -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="cloud-name" class="block text-sm font-medium text-gray-700 mb-2">
                        클라우드 이름 *
                    </label>
                    <input type="text" id="cloud-name" name="cloud_name" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="예: Production-AWS">
                </div>
                
                <div>
                    <label for="account-id" class="block text-sm font-medium text-gray-700 mb-2">
                        AWS 계정 ID *
                    </label>
                    <input type="text" id="account-id" name="account_id" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="123456789012" maxlength="12">
                </div>
                
                <div>
                    <label for="primary-region" class="block text-sm font-medium text-gray-700 mb-2">
                        기본 리전 *
                    </label>
                    <select id="primary-region" name="primary_region" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">리전을 선택하세요</option>
                        <option value="ap-northeast-2">ap-northeast-2 (Seoul)</option>
                        <option value="ap-northeast-1">ap-northeast-1 (Tokyo)</option>
                        <option value="us-east-1">us-east-1 (N. Virginia)</option>
                        <option value="us-west-2">us-west-2 (Oregon)</option>
                        <option value="eu-west-1">eu-west-1 (Ireland)</option>
                    </select>
                </div>
                
                <div>
                    <label for="contact-email" class="block text-sm font-medium text-gray-700 mb-2">
                        담당자 이메일 *
                    </label>
                    <input type="email" id="contact-email" name="contact_email" required
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           placeholder="admin@company.com">
                </div>
            </div>
            
            <!-- 계정 정보 요약 카드 -->
            <div id="account-summary" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
                <h5 class="font-medium text-blue-900 mb-2">연결할 계정 정보</h5>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-blue-700 font-medium">클라우드 이름:</span>
                        <span id="summary-cloud-name" class="ml-2 text-blue-800">-</span>
                    </div>
                    <div>
                        <span class="text-blue-700 font-medium">계정 ID:</span>
                        <span id="summary-account-id" class="ml-2 text-blue-800">-</span>
                    </div>
                    <div>
                        <span class="text-blue-700 font-medium">연결 방식:</span>
                        <span id="summary-connection-type" class="ml-2 text-blue-800">-</span>
                    </div>
                    <div>
                        <span class="text-blue-700 font-medium">기본 리전:</span>
                        <span id="summary-region" class="ml-2 text-blue-800">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Connection Method Specific Fields -->
            <!-- Role Method Fields -->
            <div class="connection-fields" id="role-fields">
                <h4 class="font-medium text-gray-900 mb-4">Cross-Account Role 정보</h4>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="role-arn" class="block text-sm font-medium text-gray-700 mb-2">
                            Role ARN *
                        </label>
                        <input type="text" id="role-arn" name="role_arn"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="arn:aws:iam::123456789012:role/WALBRole">
                    </div>
                    
                    <div>
                        <label for="external-id" class="block text-sm font-medium text-gray-700 mb-2">
                            External ID
                        </label>
                        <input type="text" id="external-id" name="external_id"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="optional-external-id">
                    </div>
                </div>
            </div>
            
            <!-- Access Key Method Fields -->
            <div class="connection-fields hidden" id="access-key-fields">
                <h4 class="font-medium text-gray-900 mb-4">Access Key 정보</h4>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <label for="access-key" class="block text-sm font-medium text-gray-700 mb-2">
                            Access Key ID *
                        </label>
                        <input type="text" id="access-key" name="access_key"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="AKIAIOSFODNN7EXAMPLE">
                    </div>
                    
                    <div>
                        <label for="secret-key" class="block text-sm font-medium text-gray-700 mb-2">
                            Secret Access Key *
                        </label>
                        <input type="password" id="secret-key" name="secret_key"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY">
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Step 4: Connection Test -->
    <div class="step-content hidden" id="step-4">
        <h3 class="text-lg font-semibold mb-4">🧪 연결 테스트</h3>
        
        <!-- 입력 정보 요약 카드 -->
        <div id="test-summary-card" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <h4 class="font-semibold text-blue-900 mb-4 flex items-center">
                <span class="text-xl mr-2">📋</span>
                연결할 계정 정보 확인
            </h4>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <!-- 기본 정보 -->
                <div class="bg-white border border-blue-200 rounded-lg p-4">
                    <h5 class="font-medium text-blue-800 mb-3">기본 정보</h5>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700 font-medium">클라우드 이름:</span>
                            <span id="test-summary-cloud-name" class="text-blue-900 font-semibold">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700 font-medium">AWS 계정 ID:</span>
                            <span id="test-summary-account-id" class="text-blue-900 font-mono">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700 font-medium">기본 리전:</span>
                            <span id="test-summary-region" class="text-blue-900">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-blue-700 font-medium">담당자 이메일:</span>
                            <span id="test-summary-email" class="text-blue-900">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- 연결 방식 정보 -->
                <div class="bg-white border border-blue-200 rounded-lg p-4">
                    <h5 class="font-medium text-blue-800 mb-3">연결 방식</h5>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-blue-700 font-medium">방식:</span>
                            <span id="test-summary-connection-type" class="text-blue-900 font-semibold">-</span>
                        </div>
                        <!-- Role 방식일 때 -->
                        <div id="test-summary-role-info" class="hidden">
                            <div class="flex justify-between mb-1">
                                <span class="text-blue-700 font-medium">Role ARN:</span>
                            </div>
                            <div class="bg-blue-50 p-2 rounded text-xs font-mono break-all">
                                <span id="test-summary-role-arn">-</span>
                            </div>
                            <div class="flex justify-between mt-2">
                                <span class="text-blue-700 font-medium">External ID:</span>
                                <span id="test-summary-external-id" class="text-blue-900 font-mono">-</span>
                            </div>
                        </div>
                        <!-- Access Key 방식일 때 -->
                        <div id="test-summary-key-info" class="hidden">
                            <div class="flex justify-between">
                                <span class="text-blue-700 font-medium">Access Key ID:</span>
                                <span id="test-summary-access-key" class="text-blue-900 font-mono">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-700 font-medium">Secret Key:</span>
                                <span class="text-blue-900 font-mono">••••••••••••••••</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-100 border border-blue-300 rounded-lg p-3">
                <p class="text-blue-800 text-sm flex items-center">
                    <span class="mr-2">💡</span>
                    <strong>확인 사항:</strong> 위 정보가 정확한지 확인하신 후 연결 테스트를 진행해주세요.
                </p>
            </div>
        </div>
        
        <div id="test-waiting" class="text-center py-8">
            <div class="text-4xl mb-4">🔗</div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">연결 테스트 준비 완료</h4>
            <p class="text-gray-600 mb-6">입력하신 정보로 AWS 연결을 테스트합니다.</p>
            <button id="test-connection-btn" 
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                🧪 연결 테스트 시작
            </button>
        </div>
        
        <div id="test-progress" class="hidden text-center py-8">
            <div class="loading-spinner w-8 h-8 mx-auto mb-4"></div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">연결 테스트 중...</h4>
            <p class="text-gray-600">AWS 자격증명을 확인하고 있습니다.</p>
        </div>
        
        <div id="test-result" class="hidden">
            <!-- 연결 테스트 성공 -->
            <div id="test-success" class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 hidden">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-lg mr-3">✓</div>
                    <h4 class="text-lg font-semibold text-green-900">연결 테스트 성공!</h4>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="bg-white border border-green-200 rounded-lg p-3">
                        <div class="text-sm text-green-700 font-medium">계정 ID</div>
                        <div id="result-account-id" class="text-green-900 font-semibold">-</div>
                    </div>
                    <div class="bg-white border border-green-200 rounded-lg p-3">
                        <div class="text-sm text-green-700 font-medium">접근 가능 리전</div>
                        <div id="result-regions" class="text-green-900 font-semibold">-</div>
                    </div>
                    <div class="bg-white border border-green-200 rounded-lg p-3">
                        <div class="text-sm text-green-700 font-medium">연결 시간</div>
                        <div id="result-connection-time" class="text-green-900 font-semibold">-</div>
                    </div>
                </div>
                
                <!-- 서비스별 권한 테스트 결과 -->
                <div id="service-test-results" class="mt-4">
                    <h5 class="font-medium text-green-900 mb-3">AWS 서비스 권한 테스트 결과</h5>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border border-green-200 rounded-lg">
                            <thead class="bg-green-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-green-700">서비스</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-green-700">상태</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-green-700">설명</th>
                                    <th class="px-4 py-2 text-left text-sm font-medium text-green-700">응답 시간</th>
                                </tr>
                            </thead>
                            <tbody id="service-test-table-body">
                                <!-- 동적으로 생성됨 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- 연결 테스트 실패 -->
            <div id="test-failure" class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6 hidden">
                <div class="flex items-center mb-4">
                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white text-lg mr-3">✗</div>
                    <h4 class="text-lg font-semibold text-red-900">연결 테스트 실패</h4>
                </div>
                
                <div class="bg-white border border-red-200 rounded-lg p-4">
                    <h5 class="font-medium text-red-800 mb-2">오류 메시지</h5>
                    <div id="error-message" class="text-red-700 mb-4">-</div>
                    
                    <h5 class="font-medium text-red-800 mb-2">해결 방법</h5>
                    <div id="error-solution" class="text-red-600 text-sm">
                        <ul class="list-disc list-inside space-y-1">
                            <li>AWS 자격증명이 올바른지 확인하세요</li>
                            <li>IAM 권한이 적절히 설정되었는지 확인하세요</li>
                            <li>네트워크 연결 상태를 확인하세요</li>
                            <li>입력한 정보가 정확한지 다시 확인하세요</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="flex justify-between mt-8 pt-6 border-t">
        <button id="prev-btn" 
                class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-medium disabled:opacity-50"
                disabled>
            ← 이전
        </button>
        
        <button id="next-btn" 
                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium disabled:opacity-50"
                disabled>
            다음 →
        </button>
        
        <button id="save-btn" 
                class="hidden px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
            💾 계정 저장
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pages/connection.js') }}"></script>
{% endblock %}